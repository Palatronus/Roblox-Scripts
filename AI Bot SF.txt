-- LinkedSwordAI_FullWorking.lua
-- Complete working version with all essential features

local function forcePrint(...)
    local args = {...}
    local message = ""
    for i, v in ipairs(args) do
        message = message .. tostring(v) .. (i < #args and " " or "")
    end
    print("LinkedSwordAI: " .. message)
    warn("LinkedSwordAI: " .. message)
end

forcePrint("Starting complete working version...")

-- Configuration
local CONFIG = {
    ATTACK_RANGE = 15,
    ATTACK_COOLDOWN = 0.8,
    DETECTION_RANGE = 100,
    VOID_Y_LEVEL = -20,
    EQUIP_DELAY = 0.5,
    RETARGET_DELAY = 1,
    FORCEFIELD_FLEE_DISTANCE = 25,
    STUCK_CHECK_DISTANCE = 3
}

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

if not LocalPlayer then
    forcePrint("Error: No local player found")
    return
end

-- Simple GUI
local function CreateSimpleGUI()
    local success, gui = pcall(function()
        local ScreenGui = Instance.new("ScreenGui")
        ScreenGui.Name = "LinkedSwordAI_GUI"
        ScreenGui.Parent = game:GetService("CoreGui")
        
        local Frame = Instance.new("Frame")
        Frame.Size = UDim2.new(0, 200, 0, 80)
        Frame.Position = UDim2.new(0, 10, 0, 10)
        Frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
        Frame.BackgroundTransparency = 0.7
        Frame.BorderSizePixel = 1
        
        local Status = Instance.new("TextLabel")
        Status.Size = UDim2.new(1, 0, 0, 20)
        Status.Position = UDim2.new(0, 0, 0, 0)
        Status.BackgroundTransparency = 1
        Status.TextColor3 = Color3.fromRGB(255, 255, 255)
        Status.Text = "Status: Loading..."
        Status.Font = Enum.Font.SourceSans
        Status.TextSize = 14
        Status.TextXAlignment = Enum.TextXAlignment.Left
        Status.Parent = Frame
        
        local Target = Instance.new("TextLabel")
        Target.Size = UDim2.new(1, 0, 0, 20)
        Target.Position = UDim2.new(0, 0, 0, 20)
        Target.BackgroundTransparency = 1
        Target.TextColor3 = Color3.fromRGB(255, 255, 255)
        Target.Text = "Target: None"
        Target.Font = Enum.Font.SourceSans
        Target.TextSize = 14
        Target.TextXAlignment = Enum.TextXAlignment.Left
        Target.Parent = Frame
        
        local Distance = Instance.new("TextLabel")
        Distance.Size = UDim2.new(1, 0, 0, 20)
        Distance.Position = UDim2.new(0, 0, 0, 40)
        Distance.BackgroundTransparency = 1
        Distance.TextColor3 = Color3.fromRGB(255, 255, 255)
        Distance.Text = "Distance: N/A"
        Distance.Font = Enum.Font.SourceSans
        Distance.TextSize = 14
        Distance.TextXAlignment = Enum.TextXAlignment.Left
        Distance.Parent = Frame
        
        Frame.Parent = ScreenGui
        
        return {
            UpdateStatus = function(text) Status.Text = "Status: " .. text end,
            UpdateTarget = function(text) Target.Text = "Target: " .. text end,
            UpdateDistance = function(text) Distance.Text = "Distance: " .. text end
        }
    end)
    
    return success and gui or nil
end

-- Main AI function
local function InitializeAI()
    forcePrint("Initializing AI system...")
    
    -- Persistent data
    if not _G.LinkedSwordAIData then
        _G.LinkedSwordAIData = {
            GUI = nil,
            Sword = nil,
            CurrentTarget = nil,
            LastAttack = 0,
            LastRetarget = 0,
            PlayersWithForceField = {}
        }
    end
    
    local data = _G.LinkedSwordAIData
    
    -- Create GUI
    if not data.GUI then
        data.GUI = CreateSimpleGUI()
    end
    
    if data.GUI then
        data.GUI.UpdateStatus("Initializing...")
    end
    
    -- Wait for character
    local character = LocalPlayer.Character
    if not character then
        forcePrint("Waiting for character...")
        character = LocalPlayer.CharacterAdded:Wait()
        wait(1) -- Wait for character to fully load
    end
    
    local humanoid = character:WaitForChild("Humanoid")
    local rootPart = character:WaitForChild("HumanoidRootPart")
    
    forcePrint("Character loaded successfully")
    
    -- Sword handling
    local function EquipSword()
        -- Check character first
        for _, item in pairs(character:GetChildren()) do
            if item:IsA("Tool") then
                data.Sword = item
                forcePrint("Found sword: " .. item.Name)
                return item
            end
        end
        
        -- Check backpack
        local backpack = LocalPlayer:FindFirstChild("Backpack")
        if backpack then
            for _, item in pairs(backpack:GetChildren()) do
                if item:IsA("Tool") then
                    -- Equip the tool
                    humanoid:EquipTool(item)
                    wait(0.2) -- Wait for equip to complete
                    data.Sword = character:FindFirstChild(item.Name) or item
                    forcePrint("Equipped sword: " .. item.Name)
                    return data.Sword
                end
            end
        end
        
        forcePrint("No sword found")
        return nil
    end
    
    -- Initial equip
    spawn(function()
        wait(CONFIG.EQUIP_DELAY)
        EquipSword()
    end)
    
    -- Player detection with forcefield check
    local function FindPlayersInRange()
        local playersInRange = {}
        local playersWithFF = {}
        local currentPos = rootPart.Position
        
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character then
                local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
                local targetHumanoid = player.Character:FindFirstChild("Humanoid")
                
                if targetRoot and targetHumanoid and targetHumanoid.Health > 0 then
                    local distance = (targetRoot.Position - currentPos).Magnitude
                    
                    if distance <= CONFIG.DETECTION_RANGE then
                        -- Check for forcefield
                        if player.Character:FindFirstChild("ForceField") then
                            playersWithFF[player] = true
                            forcePrint("Forcefield detected on: " .. player.Name)
                        else
                            table.insert(playersInRange, {
                                Player = player,
                                Distance = distance,
                                Position = targetRoot.Position,
                                Humanoid = targetHumanoid
                            })
                        end
                    end
                end
            end
        end
        
        data.PlayersWithForceField = playersWithFF
        
        -- Sort by distance
        table.sort(playersInRange, function(a, b)
            return a.Distance < b.Distance
        end)
        
        return playersInRange
    end
    
    -- Void protection
    local function CheckVoidSafety()
        return rootPart.Position.Y > CONFIG.VOID_Y_LEVEL
    end
    
    -- Stuck detection (above players)
    local function CheckStuckAbovePlayer()
        for _, player in pairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character then
                local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
                if targetRoot then
                    local horizontalDist = (Vector3.new(rootPart.Position.X, 0, rootPart.Position.Z) - 
                                          Vector3.new(targetRoot.Position.X, 0, targetRoot.Position.Z)).Magnitude
                    local verticalDiff = rootPart.Position.Y - targetRoot.Position.Y
                    
                    if horizontalDist < CONFIG.STUCK_CHECK_DISTANCE and verticalDiff > 5 then
                        return true, player
                    end
                end
            end
        end
        return false, nil
    end
    
    -- Combat behaviors
    local combatBehaviors = {
        Defensive = function(targetPos, currentPos, distance)
            -- Stay back and wait for opportunities
            if distance > 10 then
                humanoid:MoveTo(targetPos)
            else
                -- Small strafing movements
                local lookVector = (targetPos - currentPos).Unit
                local strafeDir = lookVector:Cross(Vector3.new(0, 1, 0)).Unit
                humanoid:MoveTo(currentPos + strafeDir * 3)
            end
            return "Defensive"
        end,
        
        Offensive = function(targetPos, currentPos, distance)
            -- Aggressive approach
            humanoid:MoveTo(targetPos)
            return "Offensive"
        end,
        
        OffensiveDefensive = function(targetPos, currentPos, distance)
            -- Mixed behavior
            local lookVector = (targetPos - currentPos).Unit
            if distance > 12 then
                humanoid:MoveTo(targetPos)
            else
                -- Strafe while approaching
                local strafeDir = lookVector:Cross(Vector3.new(0, 1, 0)).Unit
                local movePos = currentPos + strafeDir * 2 + lookVector * 1
                humanoid:MoveTo(movePos)
            end
            return "Offensive-Defensive"
        end
    }
    
    local lastBehaviorChange = 0
    local currentBehavior = "Defensive"
    
    local function SelectCombatBehavior(targetPos, currentPos, distance)
        -- Change behavior every 5 seconds
        if tick() - lastBehaviorChange > 5 then
            lastBehaviorChange = tick()
            local behaviors = {"Defensive", "Offensive", "OffensiveDefensive"}
            currentBehavior = behaviors[math.random(1, 3)]
            forcePrint("Switched to " .. currentBehavior .. " behavior")
        end
        
        return combatBehaviors[currentBehavior](targetPos, currentPos, distance)
    end
    
    -- Attack function
    local function ExecuteAttack()
        if not data.Sword or tick() - data.LastAttack < CONFIG.ATTACK_COOLDOWN then
            return
        end
        
        data.LastAttack = tick()
        
        spawn(function()
            for i = 1, 3 do
                pcall(function()
                    if data.Sword and data.Sword.Parent then
                        data.Sword:Activate()
                    end
                end)
                wait(0.1)
            end
        end)
    end
    
    -- Forcefield evasion
    local function HandleForceFieldEvasion()
        local closestFFPlayer = nil
        local closestDistance = math.huge
        
        for player, _ in pairs(data.PlayersWithForceField) do
            if player.Character then
                local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
                if targetRoot then
                    local distance = (targetRoot.Position - rootPart.Position).Magnitude
                    if distance < closestDistance then
                        closestDistance = distance
                        closestFFPlayer = player
                    end
                end
            end
        end
        
        if closestFFPlayer and closestDistance < CONFIG.FORCEFIELD_FLEE_DISTANCE then
            local fleeDir = (rootPart.Position - closestFFPlayer.Character.HumanoidRootPart.Position).Unit
            humanoid:MoveTo(rootPart.Position + fleeDir * 15)
            return true
        end
        
        return false
    end
    
    -- Main loop
    local connection
    connection = RunService.Heartbeat:Connect(function()
        -- Check void safety first
        if not CheckVoidSafety() then
            if data.GUI then data.GUI.UpdateStatus("VOID DANGER") end
            humanoid:MoveTo(rootPart.Position + Vector3.new(0, 10, 0))
            return
        end
        
        -- Check if stuck above player
        local isStuck, stuckPlayer = CheckStuckAbovePlayer()
        if isStuck then
            if data.GUI then data.GUI.UpdateStatus("Unstucking") end
            local moveDir = (rootPart.Position - stuckPlayer.Character.HumanoidRootPart.Position).Unit
            humanoid:MoveTo(rootPart.Position + moveDir * 8)
            return
        end
        
        -- Forcefield evasion
        if HandleForceFieldEvasion() then
            if data.GUI then data.GUI.UpdateStatus("Evading ForceField") end
            return
        end
        
        -- Find players
        local playersInRange = FindPlayersInRange()
        local currentTime = tick()
        
        -- Target selection
        if #playersInRange > 0 and (not data.CurrentTarget or 
           currentTime - data.LastRetarget > CONFIG.RETARGET_DELAY) then
            
            data.LastRetarget = currentTime
            data.CurrentTarget = playersInRange[1]
            
            if data.GUI then
                data.GUI.UpdateTarget(data.CurrentTarget.Player.Name)
            end
            forcePrint("New target: " .. data.CurrentTarget.Player.Name)
        end
        
        -- Target engagement
        if data.CurrentTarget then
            local targetData = data.CurrentTarget
            local targetChar = targetData.Player.Character
            
            if targetChar then
                local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")
                local targetHumanoid = targetChar:FindFirstChild("Humanoid")
                
                if targetRoot and targetHumanoid and targetHumanoid.Health > 0 then
                    local distance = targetData.Distance
                    
                    if data.GUI then
                        data.GUI.UpdateDistance(math.floor(distance))
                    end
                    
                    -- Face target properly
                    local lookVector = (targetRoot.Position - rootPart.Position).Unit
                    humanoid:MoveTo(rootPart.Position + lookVector * 0.5)
                    
                    -- Select and execute combat behavior
                    local behavior = SelectCombatBehavior(targetRoot.Position, rootPart.Position, distance)
                    
                    if data.GUI then
                        data.GUI.UpdateStatus(behavior)
                    end
                    
                    -- Attack if in range
                    if distance <= CONFIG.ATTACK_RANGE then
                        ExecuteAttack()
                    end
                else
                    data.CurrentTarget = nil
                    if data.GUI then
                        data.GUI.UpdateTarget("None")
                        data.GUI.UpdateStatus("Target Died")
                    end
                end
            else
                data.CurrentTarget = nil
                if data.GUI then
                    data.GUI.UpdateTarget("None")
                end
            end
        else
            data.CurrentTarget = nil
            if data.GUI then
                data.GUI.UpdateStatus("Searching")
                data.GUI.UpdateTarget("None")
                data.GUI.UpdateDistance("N/A")
            end
        end
    end)
    
    -- Handle character death
    humanoid.Died:Connect(function()
        forcePrint("Character died - cleaning up")
        if connection then
            connection:Disconnect()
        end
        if data.GUI then
            data.GUI.UpdateStatus("Dead")
        end
    end)
    
    if data.GUI then
        data.GUI.UpdateStatus("Active")
    end
    
    forcePrint("AI system fully operational")
end

-- Respawn handling
LocalPlayer.CharacterAdded:Connect(function(character)
    forcePrint("Character respawned - reinitializing")
    wait(1.5) -- Wait for character to load
    InitializeAI()
end)

-- Start the AI
forcePrint("Starting AI in 3 seconds...")
wait(3)
InitializeAI()

forcePrint("LinkedSwordAI fully loaded and running")
