local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Player = Players.LocalPlayer

-- GUI Setup
local ShiftLockUI = Instance.new("ScreenGui")
ShiftLockUI.Parent = game:GetService("CoreGui")
ShiftLockUI.ResetOnSpawn = false

local ToggleButton = Instance.new("ImageButton")
ToggleButton.Parent = ShiftLockUI
ToggleButton.BackgroundTransparency = 1
ToggleButton.Size = UDim2.new(0, 40, 0, 40)
ToggleButton.Position = UDim2.new(1, -50, 0.5, -20)
ToggleButton.Image = "rbxasset://textures/ui/mouseLock_off@2x.png"

-- System Variables
local IsActive = false
local RenderConnection
local Yaw = 0
local Pitch = 0
local Sensitivity = 0.5
local CenterPosition = Vector2.new(0.5, 0.5) -- Screen center for virtual cursor

local function ForceCameraUpdate()
    local character = Player.Character
    local rootPart = character and character:FindFirstChild("HumanoidRootPart")
    local camera = workspace.CurrentCamera
    
    if not (rootPart and camera) then return end
    
    -- Update character rotation
    rootPart.CFrame = CFrame.new(rootPart.Position) * CFrame.Angles(0, math.rad(Yaw), 0)
    
    -- Update camera orientation
    camera.CFrame = CFrame.new(rootPart.Position)
        * CFrame.Angles(math.rad(-Pitch), math.rad(Yaw), 0)
        * CFrame.new(0, 3, 8) -- 3rd person offset
end

local function VirtualRMBAction()
    local mouseDelta = UserInputService:GetMouseDelta()
    
    -- Simulate centered cursor by resetting delta
    UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
    
    -- Update rotations
    Yaw = Yaw - (mouseDelta.X * Sensitivity)
    Pitch = math.clamp(Pitch + (mouseDelta.Y * Sensitivity), -70, 70)
    
    ForceCameraUpdate()
end

ToggleButton.MouseButton1Click:Connect(function()
    IsActive = not IsActive
    ToggleButton.Image = IsActive and "rbxasset://textures/ui/mouseLock_on@2x.png" 
        or "rbxasset://textures/ui/mouseLock_off@2x.png"

    if IsActive then
        -- Initialize virtual RMB mode
        Player.Character.Humanoid.AutoRotate = false
        workspace.CurrentCamera.CameraType = Enum.CameraType.Scriptable
        UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
        
        -- Reset rotations
        Yaw = Player.Character.HumanoidRootPart.Orientation.Y
        Pitch = 0
        
        RenderConnection = RunService.RenderStepped:Connect(VirtualRMBAction)
    else
        -- Cleanup
        Player.Character.Humanoid.AutoRotate = true
        workspace.CurrentCamera.CameraType = Enum.CameraType.Custom
        UserInputService.MouseBehavior = Enum.MouseBehavior.Default
        if RenderConnection then
            RenderConnection:Disconnect()
        end
    end
end)
