-- Explicit service initialization with nil checks
local function getService(serviceName)
    local service = game:GetService(serviceName)
    if not service then
        error("Service not found: "..serviceName)
    end
    return service
end

local UserInputService = getService("UserInputService")
local Players = getService("Players")
local RunService = getService("RunService")

-- Player validation
local LocalPlayer = Players.LocalPlayer
if not LocalPlayer then
    Players:GetPropertyChangedSignal("LocalPlayer"):Wait()
    LocalPlayer = Players.LocalPlayer
end

-- Mouse initialization
local Mouse
repeat
    Mouse = LocalPlayer:GetMouse()
    task.wait()
until Mouse

-- Core configuration
local shiftlockEnabled = false
local currentMouseBehavior = Enum.MouseBehavior.Default

-- UI container creation with parent validation
local ShiftlockGUI = Instance.new("ScreenGui")
ShiftlockGUI.Name = "ShiftlockSystem"
ShiftlockGUI.ResetOnSpawn = false

local PlayerGui
repeat
    PlayerGui = LocalPlayer:FindFirstChild("PlayerGui")
    task.wait()
until PlayerGui
ShiftlockGUI.Parent = PlayerGui

-- Mouse target frame
local TargetFrame = Instance.new("Frame")
TargetFrame.Size = UDim2.new(0, 0, 0, 0)
TargetFrame.Visible = false
TargetFrame.Parent = ShiftlockGUI

-- Safe mouse behavior update
local function UpdateMouseBehavior()
    pcall(function()
        UserInputService.MouseBehavior = currentMouseBehavior
        Mouse.TargetFilter = shiftlockEnabled and TargetFrame or nil
    end)
end

-- Input handling with explicit checks
UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.LeftShift then
        shiftlockEnabled = not shiftlockEnabled
        
        currentMouseBehavior = shiftlockEnabled and (
            UserInputService.TouchEnabled 
            and Enum.MouseBehavior.LockCurrentPosition 
            or Enum.MouseBehavior.LockCenter
        ) or Enum.MouseBehavior.Default
        
        TargetFrame.Visible = shiftlockEnabled
        UpdateMouseBehavior()
    end
end)

-- Behavior enforcement with error suppression
RunService.Heartbeat:Connect(function()
    pcall(UpdateMouseBehavior)
end)

print("Shiftlock system initialized successfully")
