local uis = game:GetService("UserInputService")
local runservice = game:GetService("RunService")
local plrs = game:GetService("Players")
local lp = plrs.LocalPlayer
local mouse = lp:GetMouse()
local e = Enum

-- Proper enum initialization
local enumMLCP = e.MouseBehavior.LockCurrentPosition
local enumMLC = uis.TouchEnabled and enumMLCP or e.MouseBehavior.LockCenter
local enumMD = e.MouseBehavior.Default

-- Core shiftlock system
local shiftlock = false
local mouseBehavior = enumMD
local lastMouseBehavior = uis.MouseBehavior

-- Create essential UI elements
local gui = Instance.new("ScreenGui")
gui.Name = "PatchmaShiftlock"
gui.ZIndexBehavior = e.ZIndexBehavior.Sibling
gui.ResetOnSpawn = false
gui.Parent = lp:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Name = "MainFrame"
mainFrame.AnchorPoint = Vector2.new(0.5, 0)
mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
mainFrame.Size = UDim2.new(0, 0, 0, 0) -- Zero size but exists for targeting
mainFrame.Visible = false
mainFrame.Parent = gui

-- Mouse behavior enforcement
uis:GetPropertyChangedSignal("MouseBehavior"):Connect(function()
    if uis.MouseBehavior ~= mouseBehavior then
        uis.MouseBehavior = mouseBehavior
    end
end)

-- Shiftlock toggle
uis.InputBegan:Connect(function(input)
    if input.KeyCode == e.KeyCode.LeftShift then
        shiftlock = not shiftlock
        mouseBehavior = shiftlock and enumMLC or enumMD
        mainFrame.Visible = shiftlock
        
        -- Proper mouse target filtering
        mouse.TargetFilter = shiftlock and mainFrame or nil
    end
end)

-- Touch compatibility
if uis.TouchEnabled then
    uis.TouchTap:Connect(function(touchPos)
        if shiftlock then
            mouseBehavior = enumMLCP
        end
    end
end

-- Initialize properly
runservice.Heartbeat:Connect(function()
    if shiftlock then
        -- Maintain lock position
        uis.MouseBehavior = mouseBehavior
    end
end)

print("Shiftlock system initialized successfully! Press Left Shift to toggle")
