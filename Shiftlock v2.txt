local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- Configuration
local SHIFT_LOCK_ENABLED = false
local MOUSE_SENSITIVITY = Vector2.new(0.25, 0.25)
local BASE_OFFSET = Vector3.new(0, 3, 10)

-- State management
local character, humanoid, rootPart
local cameraAngle = Vector2.new()
local lastCameraCFrame = CFrame.new()

-- Initialize character references
local function InitializeCharacter()
    character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    humanoid = character:WaitForChild("Humanoid")
    rootPart = character:WaitForChild("HumanoidRootPart")
end

-- Full shiftlock toggle system
local function ToggleShiftlock()
    SHIFT_LOCK_ENABLED = not SHIFT_LOCK_ENABLED
    
    -- Set mouse behavior
    UserInputService.MouseBehavior = SHIFT_LOCK_ENABLED and 
        (UserInputService.TouchEnabled 
            and Enum.MouseBehavior.LockCurrentPosition 
            or Enum.MouseBehavior.LockCenter) 
        or Enum.MouseBehavior.Default
    
    -- Configure camera control
    Camera.CameraType = SHIFT_LOCK_ENABLED and Enum.CameraType.Scriptable or Enum.CameraType.Custom
    
    if SHIFT_LOCK_ENABLED then
        -- Initialize camera position
        cameraAngle = Vector2.new(math.rad(-15), 0)
        lastCameraCFrame = rootPart.CFrame * CFrame.new(BASE_OFFSET)
    end
end

-- Camera rotation logic
local function UpdateCamera()
    if not SHIFT_LOCK_ENABLED or not rootPart then return end
    
    -- Get mouse delta
    local mouseDelta = UserInputService:GetMouseDelta()
    cameraAngle += Vector2.new(
        -mouseDelta.Y * MOUSE_SENSITIVITY.Y,
        mouseDelta.X * MOUSE_SENSITIVITY.X
    )
    
    -- Clamp vertical angle
    cameraAngle = Vector2.new(
        math.clamp(cameraAngle.X, math.rad(-60), math.rad(60)),
        cameraAngle.Y
    )
    
    -- Calculate camera transform
    local rootPosition = rootPart.Position
    local cameraRot = CFrame.Angles(cameraAngle.X, cameraAngle.Y, 0)
    local cameraOffset = cameraRot * BASE_OFFSET
    
    -- Apply smooth camera movement
    local targetCFrame = CFrame.new(rootPosition + cameraOffset, rootPosition)
    lastCameraCFrame = lastCameraCFrame:Lerp(targetCFrame, 0.3)
    Camera.CFrame = lastCameraCFrame
    
    -- Rotate character with camera
    if humanoid.MoveDirection.Magnitude > 0 then
        rootPart.CFrame = CFrame.new(rootPart.Position, rootPart.Position + lastCameraCFrame.LookVector * Vector3.new(1,0,1))
    end
end

-- Input handling
UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.LeftShift then
        ToggleShiftlock()
    end
end)

-- Character tracking
LocalPlayer.CharacterAdded:Connect(InitializeCharacter)
InitializeCharacter()

-- Camera update loop
RunService.RenderStepped:Connect(UpdateCamera)

print("Native-style ShiftLock Active - Press Shift to Toggle")
