--[[
	Shiftlock functionality extracted from patchma hub by MyWorld
	Standalone shiftlock implementation for Roblox
]]

-- Optimized function references for better performance
local osclock = os.clock
local tspawn = task.spawn
local twait = task.wait
local sin = math.sin
local cos = math.cos
local abs = math.abs
local min = math.min
local clamp = math.clamp

-- Global variables
local next = next
local pcall = pcall
local type = type
local typeof = typeof
local game = game

-- Instance creation shortcuts
local i = Instance.new 
local v2 = Vector2.new 
local v3 = Vector3.new
local c3 = Color3.new 
local cf = CFrame.new
local cfl = CFrame.lookAt
local angles = CFrame.fromEulerAngles
local u2 = UDim2.new 
local e = Enum 

-- Constants
local sine = osclock()
local deltaTime = 0
local v3_0 = v3()
local v3_101 = v3(1,0,1)
local v3_010 = v3(0,1,0)
local cf_0 = cf()
local v3_0150 = v3_010 * 1.5

-- Metamethod optimization
local getMetamethodFromErrorStack = function(userdata, f, test)
	local ret = nil
	xpcall(f, function()
		ret = debug.info(2, "f")
	end, userdata, nil, 0)
	if (type(ret) ~= "function") or not test(ret) then
		return f
	end
	return ret
end

local insSet = getMetamethodFromErrorStack(game, function(a,b,c) a[b]=c end, function(f) local a=i("Folder") local b="test" f(a,"Name",b) return a.Name==b end)
local insGet = getMetamethodFromErrorStack(game, function(a,b) return a[b] end, function(f) local a=i("Folder") local b="test" a.Name=b return f(a,"Name")==b end)
local cfGet = getMetamethodFromErrorStack(cf_0, function(a,b) return a[b] end, function(f) return f(cf(1,2,3),"Position")==v3(1,2,3) end)
local cfMul = getMetamethodFromErrorStack(cf_0, function(a,b) return a*b end, function(f) return angles(1,2,3)*angles(1,2,3)==f(angles(1,2,3),angles(1,2,3)) end)
local cfAdd = getMetamethodFromErrorStack(cf_0, function(a,b) return a+b end, function(f) return cf(1,2,3)+v3(1,2,3)==f(cf(1,2,3),v3(1,2,3)) end)
local v3Get = getMetamethodFromErrorStack(v3_0, function(a,b) return a[b] end, function(f) return v3(1,2,3).Unit==f(v3(1,2,3),"Unit") end)

-- Service references
local FindFirstChildOfClass = insGet(game, "FindFirstChildOfClass")
local GetPropertyChangedSignal = insGet(game, "GetPropertyChangedSignal")

local plrs = FindFirstChildOfClass(game, "Players")
local rus = FindFirstChildOfClass(game, "RunService")
local ws = FindFirstChildOfClass(game, "Workspace")
local uis = FindFirstChildOfClass(game, "UserInputService")
local lp = insGet(plrs, "LocalPlayer")
local mouse = insGet(lp, "GetMouse")(lp)
local pg = insGet(lp, "PlayerGui")

local heartbeat = insGet(rus, "Heartbeat")
local renderstepped = insGet(rus, "RenderStepped")
local Connect = heartbeat.Connect
local Wait = heartbeat.Wait
local GetMouseDelta = insGet(uis, "GetMouseDelta")
local IsKeyDown = insGet(uis, "IsKeyDown")

-- Shiftlock variables
local allowshiftlock = true -- Enable/disable shiftlock functionality
local shiftlock = false -- Current shiftlock state
local mouseCameraMove = false

-- Cursor management
local defaultCursor = ""
local shiftlockCursor = "rbxasset://SystemCursors/Cross" -- Crosshair cursor matching reference image

-- Function to update cursor based on shiftlock state
local function updateCursor()
	if shiftlock then
		insSet(mouse, "Icon", shiftlockCursor)
	else
		insSet(mouse, "Icon", defaultCursor)
	end
end

-- Mouse behavior enums
local enumMLCP = e.MouseBehavior.LockCurrentPosition
local enumMLC = (insGet(uis, "TouchEnabled") and enumMLCP) or e.MouseBehavior.LockCenter 
local enumMD = e.MouseBehavior.Default
local enumMM = e.UserInputType.MouseMovement
local enumMB2 = e.UserInputType.MouseButton2

-- Mouse behavior management
local mouseBehavior = nil
local lastMouseBehavior = insGet(uis, "MouseBehavior")

-- Add mouse button detection
local IsMouseButtonPressed = insGet(uis, "IsMouseButtonPressed")

-- Ensure mouse behavior stays locked when needed
Connect(GetPropertyChangedSignal(uis, "MouseBehavior"), function()
	if mouseBehavior and (insGet(uis, "MouseBehavior") ~= mouseBehavior) then
		insSet(uis, "MouseBehavior", mouseBehavior)
	end
end)

-- Key definitions
local KeyCode = e.KeyCode
local keyShift = KeyCode.LeftShift

-- Camera variables
local cam = insGet(ws, "CurrentCamera")
local camcf = insGet(cam, "CFrame")
local camcfLV = cfGet(camcf, "LookVector")
local camrot = cfl(v3_0, camcfLV)
local camcfRV = cfGet(camrot, "RightVector")
local mradN05 = -0.008726646259971648 -- Mouse sensitivity multiplier

-- Character and camera management
local c = nil
local rootpart = nil
local humanoid = nil
local cfr = cf_0
local pos = v3_0
local cammag = -25 -- Camera distance

-- Function to get character and root part
local function getCharacterAndRoot()
	c = insGet(lp, "Character")
	if c then
		rootpart = c:FindFirstChild("HumanoidRootPart") or c:FindFirstChild("Torso") or c:FindFirstChild("UpperTorso")
		humanoid = c:FindFirstChildOfClass("Humanoid")
		if rootpart then
			cfr = insGet(rootpart, "CFrame")
			pos = cfGet(cfr, "Position")
			cfr = cfl(pos, pos + cfGet(cfr, "LookVector") * v3_101)
			return true
		end
	end
	return false
end

-- Input handling for shiftlock toggle
Connect(insGet(uis, "InputBegan"), function(input, gameProcessed)
	if gameProcessed then return end
	
	local keyCode = insGet(input, "KeyCode")
	if keyCode == keyShift then
		shiftlock = allowshiftlock and not shiftlock
		updateCursor() -- Update cursor when shiftlock state changes
	end
end)

-- Mouse movement handling for camera rotation
Connect(insGet(uis, "InputChanged"), function(input, gameProcessed)
	if gameProcessed then return end
	
	local inputType = insGet(input, "UserInputType")
	if mouseCameraMove and inputType == enumMM then
		local rotation = GetMouseDelta(uis) * mradN05
		camcfLV = cfGet(cfMul(camrot, angles(rotation.Y, rotation.X, 0)), "LookVector")
		camrot = cfl(v3_0, camcfLV)
		camcfRV = cfGet(camrot, "RightVector")
	end
end)

-- Main shiftlock update loop
local function updateShiftlock()
	if not getCharacterAndRoot() then
		return
	end
	
	-- Update camera CFrame for current calculations
	camcf = insGet(cam, "CFrame")
	
	-- Update camera behavior based on shiftlock state and mouse input
	if shiftlock then
		if allowshiftlock then
			mouseBehavior = enumMLC
			mouseCameraMove = true
		else
			shiftlock = false
			updateCursor() -- Update cursor when shiftlock is disabled
		end
	elseif IsMouseButtonPressed(uis, enumMB2) then
		-- Right-click camera panning
		mouseBehavior = enumMLCP
		mouseCameraMove = true
	else
		mouseBehavior = enumMD
		mouseCameraMove = false
	end
	
	-- Apply mouse behavior if it changed
	if lastMouseBehavior ~= mouseBehavior then
		lastMouseBehavior = mouseBehavior
		insSet(uis, "MouseBehavior", mouseBehavior)
	end
	
	-- Update camera position when shiftlock is active
	if shiftlock then
		-- Disable auto-rotate for manual control
		if humanoid then
			insSet(humanoid, "AutoRotate", false)
		end
		
		-- Direct character rotation using camera look vector (SL.lua approach)
		local camLookVector = cfGet(camcf, "LookVector")
		local targetPosition = v3(
			camLookVector.X * 900000, -- MaxLength equivalent
			v3Get(pos, "Y"),
			camLookVector.Z * 900000
		)
		
		-- Apply direct rotation synchronization
		cfr = cfl(pos, targetPosition)
		insSet(rootpart, "CFrame", cfr)
		
		-- Position camera with shiftlock offset
		camcf = cfAdd(camrot, pos + v3_0150 + camcfRV * 1.75 + camcfLV * cammag)
		insSet(cam, "CFrame", camcf)
	else
		-- Re-enable auto-rotate when shiftlock is off
		if humanoid then
			insSet(humanoid, "AutoRotate", true)
		end
	end
end

-- Connect to heartbeat for continuous updates
Connect(heartbeat, updateShiftlock)

-- API for external control
local ShiftlockAPI = {
	-- Toggle shiftlock on/off
	toggle = function()
		shiftlock = allowshiftlock and not shiftlock
		updateCursor()
		return shiftlock
	end,
	
	-- Enable shiftlock
	enable = function()
		if allowshiftlock then
			shiftlock = true
			updateCursor()
		end
		return shiftlock
	end,
	
	-- Disable shiftlock
	disable = function()
		shiftlock = false
		updateCursor()
		return shiftlock
	end,
	
	-- Check if shiftlock is enabled
	isEnabled = function()
		return shiftlock
	end,
	
	-- Check if shiftlock is allowed
	isAllowed = function()
		return allowshiftlock
	end,
	
	-- Set shiftlock permission
	setAllowed = function(allowed)
		allowshiftlock = allowed
		if not allowed then
			shiftlock = false
			updateCursor()
		end
		return allowshiftlock
	end
}

-- Initialize
print("Shiftlock system loaded successfully!")
print("Use Left Shift to toggle shiftlock")
print("API available via return value")

-- Export the API
return ShiftlockAPI
