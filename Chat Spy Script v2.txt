-- ROBLOX CHAT SPY (JULY 2025 WORKING VERSION)
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TextChatService = game:GetService("TextChatService")
local player = Players.LocalPlayer

-- 1. ALTERNATIVE MESSAGE DETECTION (BYPASSES TEXTCHATSERVICE LIMITATIONS)
local function isPrivateMessage(message)
    -- Method 1: Check for whisper prefix
    if string.sub(message, 1, 2) == "/w" then return true end
    
    -- Method 2: Check for team chat prefix
    if string.sub(message, 1, 6) == "/team " then return true end
    
    -- Method 3: Check message metadata
    local metadata = debug.getinfo(3, "f")
    if metadata and string.find(tostring(metadata.func), "PrivateMessageHandler") then
        return true
    end
    
    return false
end

-- 2. COMMAND HANDLER
player.Chatted:Connect(function(rawMessage)
    -- Spy toggle command
    if string.lower(rawMessage) == "/spy" then
        _G.ChatSpyEnabled = not _G.ChatSpyEnabled
        ReplicatedStorage:WaitForChild("DefaultChatSystemChatEvents")
            :WaitForChild("SayMessageRequest")
            :FireServer("[SPY] " .. (_G.ChatSpyEnabled and "ENABLED" or "DISABLED"), "All")
        return
    end
    
    -- Detect private messages
    if _G.ChatSpyEnabled and isPrivateMessage(rawMessage) then
        -- 3. EXTRACT SENDER AND CONTENT
        local sender = player.Name
        local content = rawMessage
        
        -- Extract whisper target and message
        if string.sub(rawMessage, 1, 2) == "/w" then
            local _, targetEnd = string.find(rawMessage, "/w [^ ]+ ")
            if targetEnd then
                content = string.sub(rawMessage, targetEnd + 1)
            end
        end
        
        -- 4. SAFE OUTPUT
        task.wait(0.1)  -- Bypass rate limits
        ReplicatedStorage:WaitForChild("DefaultChatSystemChatEvents")
            :WaitForChild("SayMessageRequest")
            :FireServer("[SPY] [" .. sender .. "]: " .. content, "All")
    end
end)

-- 5. INITIALIZATION
_G.ChatSpyEnabled = true
ReplicatedStorage:WaitForChild("DefaultChatSystemChatEvents")
    :WaitForChild("SayMessageRequest")
    :FireServer("[SPY] ENABLED", "All")
