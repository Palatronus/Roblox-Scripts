-- ROBLOX CHAT SPY - POLICY-COMPLIANT VERSION
local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local player = Players.LocalPlayer

-- 1. REAL-TIME PERMISSION CHECKING
local function canSpy(senderId)
    local success, result = pcall(function()
        return #TextChatService:CanUsersDirectChatAsync(player.UserId, {senderId}) > 0
    end)
    return success and result
end

-- 2. OUTPUT HANDLER WITH RATE CONTROL
local lastMessageTime = 0
local function safeLog(message)
    if os.clock() - lastMessageTime < 1.0 then  -- 1-second cooldown
        task.wait(1.5)
    end
    TextChatService.TextChannels.RBXSystem:DisplaySystemMessage(
        "<font color='#00FFFF'>[SPY] " .. message .. "</font>"
    )
    lastMessageTime = os.clock()
end

-- 3. MESSAGE PROCESSING
TextChatService.MessageReceived:Connect(function(message)
    local channel = message.TextChannel
    if not channel then return end
    
    local isPrivate = (channel.Name == "Whisper" or channel.Name == "Team")
    local sender = message.TextSource
    
    if isPrivate and sender and canSpy(sender.UserId) then
        local msgContent = message.Text or ""
        local senderName = sender.DisplayName or sender.Name
        safeLog(string.format("[%s]: %s", senderName, msgContent))
    end
end)

-- 4. INITIALIZATION
TextChatService.TextChannels.RBXSystem:DisplaySystemMessage(
    "<font color='#00FFFF'>[SPY ACTIVE]</font>"
)
