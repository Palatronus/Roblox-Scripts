-- ROBLOX CHAT SPY (AGGRESSIVE METHOD)
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local mt = getrawmetatable(game)
local backup = mt.__namecall
local spyEnabled = true

-- 1. DIRECT MEMORY HOOK (CAPTURES ALL CHAT DATA)
setreadonly(mt, false)
mt.__namecall = newcclosure(function(...)
    local args = {...}
    local self = args[1]
    local method = getnamecallmethod()
    
    -- 2. INTERCEPT CHAT PACKETS
    if method == "FireServer" and tostring(self) == "SayMessageRequest" then
        local message = args[2]
        local channel = args[3]
        
        -- 3. LOG ALL MESSAGES REGARDLESS OF PRIVACY
        if spyEnabled and (channel == "All" or channel == "Team" or channel == "Whisper") then
            local log = string.format("[SPY] [OUTGOING] [%s]: %s", player.Name, message)
            warn(log)
            writefile("chat_spy_log.txt", log.."\n", true)
        end
    end
    return backup(...)
end)
setreadonly(mt, true)

-- 4. INTERCEPT INCOMING MESSAGES
for _, v in pairs(getgc(true)) do
    if type(v) == "function" then
        local info = getinfo(v)
        if info.name == "onMessageReceived" then
            local backup = v
            replaceclosure(v, function(...)
                local message = ...
                if spyEnabled then
                    -- 5. CAPTURE ENCRYPTED/DIRECT MESSAGES
                    local sender = message.TextSource.Name
                    local content = message.Text
                    local log = string.format("[SPY] [INCOMING] [%s]: %s", sender, content)
                    warn(log)
                    writefile("chat_spy_log.txt", log.."\n", true)
                end
                return backup(...)
            end)
        end
    end
end

-- 6. COMMAND HANDLER
player.Chatted:Connect(function(msg)
    if string.lower(msg) == "!spy" then
        spyEnabled = not spyEnabled
        warn(string.format("[SPY] STATUS: %s", spyEnabled and "ENABLED" or "DISABLED"))
    end
end)

-- 7. INITIALIZATION
warn("[SPY] INVISIBLE MODE ACTIVATED - ALL MESSAGES LOGGED TO FILE")
writefile("chat_spy_log.txt", "[CHAT SPY STARTED]\n", true)
