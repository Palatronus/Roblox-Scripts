-- ROBLOX CHAT SPY (JULY 2025 WORKING VERSION)
local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local player = Players.LocalPlayer

-- 1. DIRECT CHANNEL ACCESS
local systemChannel = TextChatService.TextChannels:WaitForChild("RBXSystem")

-- Configuration
local Config = {
    enabled = true,
    spyOnMyself = true,
    public = false
}

-- 2. STATUS MESSAGE (FIXED OUTPUT)
local function updateStatus()
    systemChannel:DisplaySystemMessage(
        "<font color='#00FFFF'>[SPY " .. (Config.enabled and "ENABLED" or "DISABLED") .. "]</font>"
    )
end

-- 3. COMMAND HANDLER (RELIABLE)
player.Chatted:Connect(function(message)
    if string.lower(message) == "/spy" then
        Config.enabled = not Config.enabled
        updateStatus()
    end
end)

-- 4. MESSAGE INTERCEPTION CORE
TextChatService.MessageReceived:Connect(function(message)
    if not Config.enabled then return end

    -- 5. ESSENTIAL CHECKS
    local textSource = message.TextSource
    if not textSource then return end
    if textSource.UserId == player.UserId and not Config.spyOnMyself then return end

    -- 6. PRIVATE MESSAGE DETECTION (2025 METHOD)
    local isPrivate = false
    local channel = message.TextChannel
    if channel then
        isPrivate = (channel.Name == "Whisper" or channel.Name == "Team")
    end

    -- 7. ALTERNATIVE DETECTION (BACKUP)
    if not isPrivate then
        isPrivate = message:GetAttribute("MessageCategory") == "Private"
    end

    if isPrivate then
        -- 8. SAFE OUTPUT WITH DELAY
        task.wait(0.15)
        local msgContent = message.Text or ""
        local senderName = textSource.DisplayName or textSource.Name
        
        -- 9. HTML-FORMATTED OUTPUT
        systemChannel:DisplaySystemMessage(
            "<font color='#00FFFF'>[SPY] [" .. senderName .. "]: " .. msgContent .. "</font>"
        )
    end
end)

-- 10. INITIALIZATION SEQUENCE
task.spawn(function()
    task.wait(1)  -- Ensure chat system is loaded
    updateStatus()
    warn("CHAT SPY ACTIVE - PRIVATE MESSAGES WILL BE LOGGED")
end)
