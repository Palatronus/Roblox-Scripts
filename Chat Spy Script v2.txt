print("-- Chat Spy Executed --")
print("Type \"/spy\" to toggle chat spy")
print("https://github.com/dehoisted/Chat-Spy")

-- Config
Config = {
    enabled = true,
    spyOnMyself = false,
    public = false,
    publicItalics = true
}

local Players = game:GetService("Players")
local player = Players.LocalPlayer
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local instance = (_G.chatSpyInstance or 0) + 1
_G.chatSpyInstance = instance

-- Track processed messages to prevent duplicates
local messageTracker = {}
local MESSAGE_TTL = 0.05  -- 50ms for high-volume spam

-- System message formatting
local function displaySystemMessage(text)
    TextChatService.TextChannels.RBXSystem:DisplaySystemMessage(
        string.format(
            '<font color="#00FFFF"><b>%s</b></font>',
            text
        )
    )
end

-- Core message processing
local function processPrivateMessage(speaker, message, messageType)
    if not Config.enabled then return end
    if speaker == player and not Config.spyOnMyself then return end
    
    -- Create unique signature for spam prevention
    local signature = speaker.UserId .. ":" .. message
    local now = tick()
    
    -- Prevent duplicate processing
    if messageTracker[signature] and (now - messageTracker[signature] < MESSAGE_TTL) then
        return
    end
    messageTracker[signature] = now
    
    -- Clean message
    local cleanMsg = message:gsub("[\n\r]", ""):gsub("\t", " "):gsub(" +", " ")
    
    if Config.public then
        local formatted = (Config.publicItalics and "/me " or "") .. "{SPY} [" .. speaker.Name .. "]: " .. cleanMsg
        TextChatService.TextChannels.RBXGeneral:SendAsync(formatted)
    else
        displaySystemMessage("{SPY} [" .. speaker.Name .. "]: " .. cleanMsg)
    end
end

-- Handle own messages
local function setupOwnMessageHook()
    player.Chatted:Connect(function(rawMessage)
        if _G.chatSpyInstance ~= instance then return end
        if not Config.enabled then return end
        if not Config.spyOnMyself then return end
        
        -- Process private messages
        if rawMessage:sub(1,3):lower() == "/w " then
            processPrivateMessage(player, rawMessage, "WHISPER")
        elseif rawMessage:sub(1,1) == "/" then
            processPrivateMessage(player, rawMessage, "COMMAND")
        end
    end)
end

-- Command handling
TextChatService.SendingMessage:Connect(function(params)
    if _G.chatSpyInstance ~= instance then return end
    
    local message = params.Text
    if string.sub(message:lower(), 1, 4) == "/spy" then
        Config.enabled = not Config.enabled
        task.wait(0.3)
        displaySystemMessage("{SPY " .. (Config.enabled and "EN" or "DIS") .. "ABLED}")
        params.Text = ""
        return
    end
end)

-- Directly monitor whisper channel
local function monitorWhisperChannel()
    local whisperChannel = TextChatService:FindFirstChild("RBXWhisper")
    if whisperChannel then
        whisperChannel:AddUserAsync(player.UserId)
        whisperChannel.MessageReceived:Connect(function(message)
            if _G.chatSpyInstance ~= instance then return end
            if not Config.enabled then return end
            
            local speaker = Players:GetPlayerByUserId(message.TextSource.UserId)
            if speaker and (speaker ~= player or Config.spyOnMyself) then
                -- Skip whispers TO local player
                if not message.Text:lower():match("^/w%s+" .. player.Name:lower() .. "%s") then
                    processPrivateMessage(speaker, message.Text, "WHISPER")
                end
            end
        end)
        return true
    end
    return false
end

-- Directly monitor team chat channel
local function monitorTeamChannel()
    local teamChannel = TextChatService:FindFirstChild("RBXTeam")
    if teamChannel then
        teamChannel:AddUserAsync(player.UserId)
        teamChannel.MessageReceived:Connect(function(message)
            if _G.chatSpyInstance ~= instance then return end
            if not Config.enabled then return end
            
            local speaker = Players:GetPlayerByUserId(message.TextSource.UserId)
            if speaker then
                processPrivateMessage(speaker, message.Text, "TEAM")
            end
        end)
        return true
    end
    return false
end

-- Setup channel monitors
if monitorWhisperChannel() then
    displaySystemMessage("{SPY WHISPER HOOK ACTIVE}")
end

if monitorTeamChannel() then
    displaySystemMessage("{SPY TEAM HOOK ACTIVE}")
end

-- Setup own message hook
setupOwnMessageHook()

-- Monitor other players' commands
for _, otherPlayer in ipairs(Players:GetPlayers()) do
    if otherPlayer ~= player then
        otherPlayer.Chatted:Connect(function(message)
            if _G.chatSpyInstance ~= instance then return end
            if not Config.enabled then return end
            
            -- Only process commands
            if message:sub(1,1) == "/" and message:sub(1,4):lower() ~= "/spy" then
                processPrivateMessage(otherPlayer, message, "COMMAND")
            end
        end)
    end
end

Players.PlayerAdded:Connect(function(newPlayer)
    newPlayer.Chatted:Connect(function(message)
        if _G.chatSpyInstance ~= instance then return end
        if not Config.enabled then return end
        
        -- Only process commands
        if message:sub(1,1) == "/" and message:sub(1,4):lower() ~= "/spy" then
            processPrivateMessage(newPlayer, message, "COMMAND")
        end
    end)
end)

-- Initial status
displaySystemMessage("{SPY " .. (Config.enabled and "EN" or "DIS") .. "ABLED}")
