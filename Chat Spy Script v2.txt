-- ROBLOX CHAT SPY (JULY 2025 VERIFIED)
local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local player = Players.LocalPlayer

-- 1. MANDATORY PRIVACY INITIALIZATION :cite[5]:cite[7]
local textChannels = TextChatService:WaitForChild("TextChannels")
local systemChannel = textChannels:WaitForChild("RBXSystem")

-- Configuration
local Config = {
    enabled = true,
    spyOnMyself = true,
    public = false
}

-- 2. ENCRYPTION COMPLIANCE CHECK :cite[5]
local function canViewMessage(senderId)
    local success, result = pcall(function()
        return #TextChatService:CanUsersDirectChatAsync(player.UserId, {senderId}) > 0
    end)
    return success and result
end

-- 3. OUTPUT WITH RATE LIMITING (PREVENTS DROPPED MESSAGES) :cite[9]
local lastOutputTime = 0
local function safeLog(message)
    if os.clock() - lastOutputTime < 1.0 then  -- 1-second cooldown
        task.wait(1.2)
    end
    systemChannel:DisplaySystemMessage("<font color='#00FFFF'>[SPY] "..message.."</font>")
    lastOutputTime = os.clock()
end

-- 4. MESSAGE PROCESSING CORE :cite[7]
TextChatService.MessageReceived:Connect(function(message)
    if not Config.enabled then return end

    local textSource = message.TextSource
    if not textSource then return end

    -- 5. CORRECT CHANNEL DETECTION (2025 STANDARD) :cite[5]
    local channel = message.TextChannel
    if not channel then return end
    local channelName = channel.Name
    local isPrivate = (channelName == "Whisper" or channelName == "Team")
    
    -- 6. ENCRYPTION CHECK FOR WHISPERS :cite[5]
    local canSpy = true
    if channelName == "Whisper" then
        canSpy = canViewMessage(textSource.UserId)
    end

    local isLocalPlayer = textSource.UserId == player.UserId

    if isPrivate and canSpy and (Config.spyOnMyself or not isLocalPlayer) then
        local msgContent = message.Text
        local senderName = textSource.DisplayName or textSource.Name
        safeLog("["..senderName.."]: "..msgContent)
    end
end)

-- 7. COMMAND HANDLER :cite[9]
player.Chatted:Connect(function(msg)
    if string.lower(msg) == "/spy" then
        Config.enabled = not Config.enabled
        systemChannel:DisplaySystemMessage(
            "<font color='#00FFFF'>[SPY "..(Config.enabled and "ENABLED" or "DISABLED").."]</font>"
        )
    end
end)

-- Initial status
systemChannel:DisplaySystemMessage("<font color='#00FFFF'>[SPY ENABLED]</font>")
