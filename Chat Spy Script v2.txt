print("-- Chat Spy Executed --")
print("Type \"spy\" to enable or disable the chat spy.")
print("Only tested if this works executed with Synapse (should work with other exploits though)")
print("https://github.com/dehoisted/Chat-Spy")

-- Config
Config = {
	enabled = true,
	spyOnMyself = true,
	public = false,
	publicItalics = true
}

-- Customizing Log Output
PrivateProperties = {
	Color = Color3.fromRGB(0,255,255); 
	Font = Enum.Font.SourceSansBold;
	TextSize = 18;
}

local StarterGui = game:GetService("StarterGui")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local TextChatService = game:GetService("TextChatService")
local instance = (_G.chatSpyInstance or 0) + 1
_G.chatSpyInstance = instance

-- Create a hidden TextChannel for message interception
local spyChannel = Instance.new("TextChannel")
spyChannel.Name = "SpyChannel"
spyChannel.Parent = TextChatService

local function processMessage(speaker, message)
	if not Config.enabled then return end
	if speaker == player and not Config.spyOnMyself then return end
	
	if Config.public then
		local text = (Config.publicItalics and "/me " or '').."{SPY} [".. speaker.Name .."]: "..message
		TextChatService.TextChannels.RBXGeneral:SendAsync(text)
	else
		PrivateProperties.Text = "{SPY} [".. speaker.Name .."]: "..message
		StarterGui:SetCore("ChatMakeSystemMessage", PrivateProperties)
	end
end

-- Message interception
spyChannel.OnIncomingMessage = function(message)
	if _G.chatSpyInstance ~= instance then return end
	if message.TextSource then
		local speaker = Players:GetPlayerByUserId(message.TextSource.UserId)
		if speaker then
			processMessage(speaker, message.Text)
		end
	end
	return message
end

-- Hook into all channels
for _, channel in pairs(TextChatService.TextChannels:GetChildren()) do
	channel:AddToChannel(spyChannel)
end

TextChatService.TextChannelAdded:Connect(function(channel)
	channel:AddToChannel(spyChannel)
end)

-- Spy toggle command
player.Chatted:Connect(function(msg)
	if _G.chatSpyInstance ~= instance then return end
	if msg:lower():sub(1,4) == "/spy" then
		Config.enabled = not Config.enabled
		wait(0.3)
		PrivateProperties.Text = "{SPY "..(Config.enabled and "EN" or "DIS").."ABLED}"
		StarterGui:SetCore("ChatMakeSystemMessage", PrivateProperties)
	end
end)

-- Initial status
PrivateProperties.Text = "{SPY "..(Config.enabled and "EN" or "DIS").."ABLED}"
StarterGui:SetCore("ChatMakeSystemMessage", PrivateProperties)
