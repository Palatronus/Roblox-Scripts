-- ROBLOX CHAT SPY (ORIGINAL BEHAVIOR RESTORED)
local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

-- Original configuration
local Config = {
    enabled = true,
    spyOnMyself = true,
    public = true,
    publicItalics = true
}

-- Original instance tracking
local instance = (_G.chatSpyInstance or 0) + 1
_G.chatSpyInstance = instance

-- Original status message
local function updateStatus()
    ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer(
        "{SPY} "..(Config.enabled and "ENABLED" or "DISABLED"),
        "All"
    )
end

-- MAIN FIX: Direct message interception
TextChatService.MessageReceived:Connect(function(message)
    if not Config.enabled or _G.chatSpyInstance ~= instance then return end
    
    -- Get message details
    local textSource = message.TextSource
    if not textSource then return end
    
    local isLocalPlayer = textSource.UserId == player.UserId
    if not Config.spyOnMyself and isLocalPlayer then return end
    
    -- Force detection of private messages
    local isPrivate = false
    if message.Text:find("/w ") or message.Text:find("/team ") then
        isPrivate = true
    else
        -- Backup detection
        local channel = message.TextChannel
        if channel then
            isPrivate = (channel.Name == "Whisper" or channel.Name == "Team")
        end
    end

    -- Re-broadcast private messages
    if isPrivate then
        local msgContent = message.Text
        local senderName = textSource.Name
        
        -- Remove command prefixes
        msgContent = msgContent:gsub("/w%S+%s", ""):gsub("/team%s", "")
        
        -- Format according to original config
        local formatted = Config.publicItalics and "/me " or ""
        formatted = formatted .. "{SPY} [".. senderName .."]: ".. msgContent
        
        -- Send to public chat (original behavior)
        ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer(
            formatted, 
            "All"
        )
    end
end)

-- Original command handler
player.Chatted:Connect(function(message)
    if string.lower(message) == "/spy" then
        Config.enabled = not Config.enabled
        updateStatus()
    end
end)

-- Initial status
ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer("{SPY} ENABLED", "All")
