--[[
   Roblox Chat Spy (Client-Side)
   Type "/spy" to toggle
   - Works with modern TextChatService
   - Fixes "Private is not a valid member" error
   - Preserves chat functionality
--]]

print("-- Chat Spy Activated --")
print("Type \"/spy\" to toggle")

-- Configuration
local Config = {
    enabled = true,
    spyOnMyself = true,
    public = false,
    publicItalics = true
}

-- Services
local TextChatService = game:GetService("TextChatService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")

-- Instance tracking
local instance = (_G.chatSpyInstance or 0) + 1
_G.chatSpyInstance = instance

-- Message styling
local SpyMessageProperties = {
    Color = Color3.fromRGB(0, 255, 255),
    Font = Enum.Font.SourceSansBold,
    TextSize = 18
}

-- Preserve original chat handler
local oldHandler = TextChatService.OnIncomingMessage

-- Toggle spy status
local function updateSpyStatus()
    SpyMessageProperties.Text = "{SPY "..(Config.enabled and "EN" or "DIS").."ABLED}"
    StarterGui:SetCore("ChatMakeSystemMessage", SpyMessageProperties)
end

-- Command handler
local function processCommand(message)
    if string.lower(message) == "/spy" then
        Config.enabled = not Config.enabled
        updateSpyStatus()
        return true
    end
    return false
end

-- Main message handler
TextChatService.OnIncomingMessage = function(message)
    -- Preserve original chat functionality
    local properties = oldHandler and oldHandler(message) or nil
    
    if _G.chatSpyInstance ~= instance then return properties end
    if not Config.enabled then return properties end
    
    local textSource = message.TextSource
    if not textSource then return properties end
    
    local isLocalPlayer = textSource.UserId == player.UserId
    if not Config.spyOnMyself and isLocalPlayer then return properties end
    
    -- Detect private messages by channel
    local channel = message:GetAttribute("ChatChannel")
    local isPrivate = false
    
    if channel then
        local channelName = channel.Name
        isPrivate = (channelName == "RBXWhisper" or channelName == "RBXTeam")
    end
    
    if isPrivate then
        local msgContent = message.Text or ""
        local senderName = textSource.Name or "Unknown"
        
        if Config.public then
            -- Prevent recursive spying
            if not msgContent:find("^{SPY}") then
                local formatted = Config.publicItalics and "/me " or ""
                formatted = formatted .. "{SPY} [".. senderName .."]: ".. msgContent
                
                -- Send to public chat
                task.spawn(function()
                    ReplicatedStorage:WaitForChild("DefaultChatSystemChatEvents"):WaitForChild("SayMessageRequest"):FireServer(formatted, "All")
                end)
            end
        else
            -- Send private system message
            SpyMessageProperties.Text = "{SPY} [".. senderName .."]: ".. msgContent
            StarterGui:SetCore("ChatMakeSystemMessage", SpyMessageProperties)
        end
    end
    
    return properties
end

-- Setup command detection
player.Chatted:Connect(processCommand)

-- Initial status
updateSpyStatus()

-- Fix for chat bar visibility (optional)
if player.PlayerGui:FindFirstChild("Chat") then
    local chatFrame = player.PlayerGui.Chat.Frame
    chatFrame.ChatChannelParentFrame.Visible = true
    chatFrame.ChatBarParentFrame.Position = chatFrame.ChatChannelParentFrame.Position + UDim2.new(UDim.new(), chatFrame.ChatChannelParentFrame.Size.Y)
end

print("Chat Spy Initialized Successfully")
