--[[
   Updated Chat Spy for TextChatService
   Type "/spy" to toggle
   Only intercepts messages visible to client (whispers, team chat)
--]]

print("-- Modern Chat Spy Loaded --")
print("Type \"/spy\" to toggle spy mode")

-- Configuration
local Config = {
    enabled = true,
    spyOnMyself = false,
    public = false,
    publicItalics = true
}

-- Message styling
local SpyMessageProperties = {
    Color = Color3.fromRGB(0, 255, 255),
    Font = Enum.Font.SourceSansBold,
    TextSize = 18
}

-- Services
local TextChatService = game:GetService("TextChatService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local systemChannel = TextChatService:WaitForChild("TextChannels"):WaitForChild("RBXSystem")

-- Instance tracking
local instance = (_G.chatSpyInstance or 0) + 1
_G.chatSpyInstance = instance

-- Toggle spy status
local function updateSpyStatus()
    systemChannel:DisplaySystemMessage(
        "<font color='#00FFFF'>[SPY " .. (Config.enabled and "ENABLED" or "DISABLED") .. "]</font>"
    )
end

-- Command handling
local function processCommand(message)
    if string.lower(message) == "/spy" then
        Config.enabled = not Config.enabled
        updateSpyStatus()
        return true
    end
    return false
end

-- Main message handler
local function handleIncomingMessage(message)
    if _G.chatSpyInstance ~= instance then return end
    if not Config.enabled then return end
    
    local textSource = message.TextSource
    if not textSource then return end
    
    local isLocalPlayer = textSource.UserId == player.UserId
    local isPrivate = (
        message.Status == Enum.TextChatMessageStatus.Private or
        message.Status == Enum.TextChatMessageStatus.FilteredPrivate
    )
    
    if isPrivate and (Config.spyOnMyself or not isLocalPlayer) then
        local msgContent = message.Text
        local senderName = textSource.Name
        
        if Config.public then
            local formatted = Config.publicItalics and "/me " or ""
            formatted = formatted .. "{SPY} [".. senderName .."]: ".. msgContent
            TextChatService.TextChannels.RBXGeneral:SendAsync(formatted)
        else
            systemChannel:DisplaySystemMessage(
                "<font color='#00FFFF'>[SPY] [".. senderName .."]: ".. msgContent .. "</font>"
            )
        end
    end
end

-- Initialize after chat loads :cite[7]
task.defer(function()
    TextChatService.OnIncomingMessage = function(message)
        local properties = oldHandler and oldHandler(message) or nil
        handleIncomingMessage(message)
        return properties
    end
    
    -- Setup command detection
    player.Chatted:Connect(processCommand)
    
    -- Initial status
    updateSpyStatus()
end)
