local Players = game:GetService("Players")
local UIS = game:GetService("UserInputService")
local LP = Players.LocalPlayer
local Toggle = true
local ArmorCooldown = false
local HealCooldown = false

-- Toggle system with status display
UIS.InputBegan:Connect(function(Input)
    if Input.KeyCode == Enum.KeyCode.H then
        Toggle = not Toggle
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "SYSTEM: "..(Toggle and "ON" or "OFF"),
            Text = Toggle and "Full functionality enabled" or "All features disabled",
            Duration = 2
        })
    end
end)

local function GetAllItems(ModelName)
    local items = {}
    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj.Name == ModelName and obj:IsA("Model") then
            local interactPart = obj:FindFirstChild("TouchInterest") and obj:FindFirstChild("TouchInterest").Parent
                            or obj:FindFirstChildWhichIsA("Part")
            if interactPart then
                table.insert(items, {
                    part = interactPart,
                    position = interactPart.Position
                })
            end
        end
    end
    return items
end

local function GetBestItem(items)
    if not LP.Character or not LP.Character:FindFirstChild("HumanoidRootPart") then return nil end
    local charPos = LP.Character.HumanoidRootPart.Position
    table.sort(items, function(a,b)
        return (charPos - a.position).Magnitude < (charPos - b.position).Magnitude
    end)
    return #items > 0 and items[1].part or nil
end

local function ForceHeal()
    if not LP.Character then return end
    local humanoid = LP.Character:FindFirstChild("Humanoid")
    if not humanoid then return end

    -- Directly trigger full heal after armor acquisition
    local healItems = GetAllItems("HealPad")
    local healPart = GetBestItem(healItems)
    
    if healPart then
        firetouchinterest(LP.Character.HumanoidRootPart, healPart, 0)
        task.wait(0.2)
        firetouchinterest(LP.Character.HumanoidRootPart, healPart, 1)
        return true
    end
    return false
end

local function CollectArmor()
    if not Toggle or ArmorCooldown then return end
    ArmorCooldown = true
    
    local armorItems = GetAllItems("BattleArmorStand")
    local armorPart = GetBestItem(armorItems)
    
    if armorPart and LP.Character then
        firetouchinterest(LP.Character.HumanoidRootPart, armorPart, 0)
        firetouchinterest(LP.Character.HumanoidRootPart, armorPart, 1)
        
        -- Force heal after successful armor acquisition
        task.wait(0.5)
        if LP.Character:FindFirstChild("BattleArmor") then
            for _ = 1, 3 do  -- Triple attempt to heal
                if ForceHeal() then break end
                task.wait(0.5)
            end
        end
    end
    ArmorCooldown = false
end

local function AutoHeal()
    if not Toggle or HealCooldown then return end
    HealCooldown = true
    
    local healItems = GetAllItems("HealPad")
    local healPart = GetBestItem(healItems)
    
    if healPart and LP.Character then
        local humanoid = LP.Character:FindFirstChild("Humanoid")
        if humanoid and humanoid.Health < humanoid.MaxHealth then
            firetouchinterest(LP.Character.HumanoidRootPart, healPart, 0)
            task.wait(0.2)  -- Extended contact time
            firetouchinterest(LP.Character.HumanoidRootPart, healPart, 1)
        end
    end
    HealCooldown = false
end

-- Enhanced health monitoring
LP.CharacterAdded:Connect(function(char)
    local humanoid = char:WaitForChild("Humanoid")
    
    humanoid.HealthChanged:Connect(function()
        if Toggle and humanoid.Health < humanoid.MaxHealth then
            AutoHeal()
            -- Emergency heal if below 50% HP
            if humanoid.Health < (humanoid.MaxHealth * 0.5) then
                ForceHeal()
            end
        end
    end)
    
    task.wait(1)
    CollectArmor()
end)

-- Aggressive item monitoring
task.spawn(function()
    while task.wait(1) do
        if Toggle then
            -- Armor check
            if LP.Character and not LP.Character:FindFirstChild("BattleArmor") then
                CollectArmor()
            end
            
            -- Health maintenance
            if LP.Character and LP.Character:FindFirstChild("Humanoid") then
                local hum = LP.Character.Humanoid
                if hum.Health < (hum.MaxHealth * 0.9) then
                    AutoHeal()
                end
            end
        end
    end
end)
