-- FE Combat Reanimation v3 (LocalScript)
local player = game:GetService("Players").LocalPlayer
local RS = game:GetService("RunService")
local UIS = game:GetService("UserInputService")

local function createFakeRig()
    local character = player.Character or player.CharacterAdded:Wait()
    local root = character:WaitForChild("HumanoidRootPart")
    
    -- Force initial death state
    character:BreakJoints()
    wait(0.5)
    
    -- Create preserved corpse
    local fakeChar = character:Clone()
    fakeChar.Name = "ReanimatedCorpse"
    fakeChar.Parent = workspace
    
    -- Remove original humanoid and joints
    for _,v in pairs(fakeChar:GetDescendants()) do
        if v:IsA("Motor6D") or v:IsA("Humanoid") then
            v:Destroy()
        end
    end
    
    -- Configure network ownership
    for _,part in pairs(fakeChar:GetChildren()) do
        if part:IsA("BasePart") then
            part:SetNetworkOwner(player)
            part.CanCollide = false
            part.Transparency = 0
        end
    end
    
    -- Create custom controller
    local bodyGyro = Instance.new("BodyGyro", root)
    local bodyVel = Instance.new("BodyVelocity", root)
    bodyGyro.MaxTorque = Vector3.new(4000, 4000, 4000)
    bodyVel.MaxForce = Vector3.new(4000, 0, 4000)
    
    -- Movement handler
    local moveVector = Vector3.new()
    UIS.InputBegan:Connect(function(input)
        local cf = fakeChar.HumanoidRootPart.CFrame
        if input.KeyCode == Enum.KeyCode.W then
            moveVector = cf.LookVector * 50 + moveVector
        elseif input.KeyCode == Enum.KeyCode.S then
            moveVector = -cf.LookVector * 50 + moveVector
        elseif input.KeyCode == Enum.KeyCode.A then
            moveVector = -cf.RightVector * 50 + moveVector
        elseif input.KeyCode == Enum.KeyCode.D then
            moveVector = cf.RightVector * 50 + moveVector
        end
    end)
    
    UIS.InputEnded:Connect(function(input)
        if input.KeyCode == Enum.KeyCode.W then
            moveVector = moveVector - fakeChar.HumanoidRootPart.CFrame.LookVector * 50
        elseif input.KeyCode == Enum.KeyCode.S then
            moveVector = moveVector + fakeChar.HumanoidRootPart.CFrame.LookVector * 50
        elseif input.KeyCode == Enum.KeyCode.A then
            moveVector = moveVector + fakeChar.HumanoidRootPart.CFrame.RightVector * 50
        elseif input.KeyCode == Enum.KeyCode.D then
            moveVector = moveVector - fakeChar.HumanoidRootPart.CFrame.RightVector * 50
        end
    end)
    
    -- Physics update
    RS.Heartbeat:Connect(function()
        bodyVel.Velocity = moveVector
        bodyGyro.CFrame = CFrame.new(fakeChar.HumanoidRootPart.Position, fakeChar.HumanoidRootPart.Position + moveVector)
    end)
    
    -- Invincibility system
    fakeChar.ChildAdded:Connect(function(child)
        if child:IsA("Humanoid") then
            child:Destroy()
        end
    end)
    
    -- Fling mechanism
    local mouse = player:GetMouse()
    mouse.Button1Down:Connect(function()
        local target = mouse.Target
        if target and target.Parent:FindFirstChild("HumanoidRootPart") then
            local hrp = target.Parent.HumanoidRootPart
            hrp:SetNetworkOwner(player)
            local bodyVelocity = Instance.new("BodyVelocity")
            bodyVelocity.Velocity = (hrp.Position - fakeChar.HumanoidRootPart.Position).Unit * -100 + Vector3.new(0, 100, 0)
            bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            bodyVelocity.Parent = hrp
            game:GetService("Debris"):AddItem(bodyVelocity, 0.1)
        end
    end)
    
    -- Handle respawned character
    player.CharacterAdded:Connect(function(newChar)
        newChar:WaitForChild("Humanoid").Health = 0
        newChar:WaitForChild("HumanoidRootPart").CFrame = CFrame.new(0, -500, 0)
        for _,part in pairs(newChar:GetChildren()) do
            if part:IsA("BasePart") then
                part.Transparency = 1
            end
        end
    end)
end

-- Initial execution
createFakeRig()
