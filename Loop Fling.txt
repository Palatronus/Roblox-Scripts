local Players = game:GetService("Players")
local LP = Players.LocalPlayer
local RS = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local Camera = workspace.CurrentCamera
local UIS = game:GetService("UserInputService")

-- GUI Setup
local GUI = Instance.new("ScreenGui")
GUI.Name = "UltimateFling"
GUI.Parent = CoreGui

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 300, 0, 180)
Frame.Position = UDim2.new(0.5, -150, 0.5, -90)
Frame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
Frame.Active = true
Frame.Parent = GUI

-- Dragging System Fix
local dragging = false
local dragStart
local startPos

Frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = Frame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

UIS.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        Frame.Position = UDim2.new(
            startPos.X.Scale, 
            startPos.X.Offset + delta.X,
            startPos.Y.Scale, 
            startPos.Y.Offset + delta.Y
        )
    end
end)

-- Fling Components
local Input = Instance.new("TextBox")
local Button = Instance.new("TextButton")
local CamToggle = Instance.new("TextButton")

Input.PlaceholderText = "Target(s), comma separated"
Input.Size = UDim2.new(0.8, 0, 0.2, 0)
Input.Position = UDim2.new(0.1, 0, 0.1, 0)
Input.Parent = Frame

Button.Text = "Toggle Fling"
Button.Size = UDim2.new(0.6, 0, 0.2, 0)
Button.Position = UDim2.new(0.2, 0, 0.4, 0)
Button.Parent = Frame

CamToggle.Text = "Track View"
CamToggle.Size = UDim2.new(0.6, 0, 0.2, 0)
CamToggle.Position = UDim2.new(0.2, 0, 0.65, 0)
CamToggle.Parent = Frame

-- Enhanced Fling Logic
local Flinging = false
local Tracking = false

local function GetTargets()
    local targets = {}
    for name in Input.Text:gmatch("[^,]+") do
        name = name:gsub("^%s+", ""):gsub("%s+$", ""):lower()
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= LP and p.Name:lower() == name then
                table.insert(targets, p)
            end
        end
    end
    return targets
end

local function CollisionBypass()
    if LP.Character then
        for _, part in pairs(LP.Character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
                part.Massless = true
            end
        end
    end
end

local function ViolentFling(target)
    local forceMultiplier = 2500
    while Flinging and task.wait(0.02) do
        if not (target and target.Character) then continue end
        CollisionBypass()
        
        local tHRP = target.Character:FindFirstChild("HumanoidRootPart")
        local myHRP = LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
        
        if tHRP and myHRP then
            -- Teleport INSIDE target with micro-offsets
            local offset = CFrame.new(
                math.random(-1.5, 1.5),  -- Tight X range
                math.random(-1, 2),      -- Body-level Y
                math.random(-1.5, 1.5)   -- Tight Z range
            )
            
            -- Direct position manipulation
            myHRP.CFrame = tHRP.CFrame * offset
            myHRP.Velocity = (tHRP.Position - myHRP.Position).Unit * forceMultiplier
                            + Vector3.new(0, forceMultiplier/1.2, 0)
            
            -- Force network update
            if tHRP:GetNetworkOwner() ~= LP then
                tHRP:SetNetworkOwner(LP)
            end
        end
    end
end

-- Camera Tracking
local function TrackTarget(target)
    while Tracking and task.wait() do
        if target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
            Camera.CameraType = Enum.CameraType.Scriptable
            Camera.CFrame = CFrame.new(
                target.Character.HumanoidRootPart.Position + Vector3.new(0, 3, 5),
                target.Character.HumanoidRootPart.Position
            )
        end
    end
end

-- Control Handlers
Button.MouseButton1Click:Connect(function()
    Flinging = not Flinging
    if Flinging then
        local targets = GetTargets()
        if #targets == 0 then return end
        
        for _, target in pairs(targets) do
            task.spawn(function() ViolentFling(target) end)
        end
    end
end)

CamToggle.MouseButton1Click:Connect(function()
    Tracking = not Tracking
    if Tracking then
        local target = GetTargets()[1]
        if target then task.spawn(function() TrackTarget(target) end) end
    else
        Camera.CameraType = Enum.CameraType.Custom
    end
end)
