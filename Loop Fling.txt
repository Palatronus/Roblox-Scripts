-- FE Velocity-Controlled Orbital Fling System
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local LP = Players.LocalPlayer

-- GUI Setup
local FlingGui = Instance.new("ScreenGui")
FlingGui.Name = "FlingControl_Final"
FlingGui.ResetOnSpawn = false
FlingGui.Enabled = true
FlingGui.DisplayOrder = 999
FlingGui.Parent = LP:WaitForChild("PlayerGui")

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 250, 0, 150)
Frame.Position = UDim2.new(0.5, -125, 0.5, -75)
Frame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
Frame.Active = true
Frame.Draggable = true
Frame.Parent = FlingGui

local TargetBox = Instance.new("TextBox")
TargetBox.Size = UDim2.new(0.9, 0, 0.3, 0)
TargetBox.Position = UDim2.new(0.05, 0, 0.1, 0)
TargetBox.PlaceholderText = "Enter Username"
TargetBox.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
TargetBox.TextColor3 = Color3.new(1, 1, 1)
TargetBox.Font = Enum.Font.Gotham
TargetBox.TextSize = 14
TargetBox.Parent = Frame

local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Size = UDim2.new(0.9, 0, 0.3, 0)
ToggleBtn.Position = UDim2.new(0.05, 0, 0.55, 0)
ToggleBtn.Text = "START FLINGING"
ToggleBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
ToggleBtn.TextColor3 = Color3.new(1, 1, 1)
ToggleBtn.Font = Enum.Font.GothamBold
ToggleBtn.TextSize = 14
ToggleBtn.Parent = Frame

-- Drag System
local dragging, dragInput, dragStart, startPos
Frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = Frame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

Frame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

UIS.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        local delta = input.Position - dragStart
        Frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

-- Fling System
local Flinging = false
local Target = nil
local FORCE = 28000
local ORBIT_ANGLE = 0
local ORBIT_RADIUS = 3.5
local ANGULAR_SPEED = 15
local VELOCITY_THRESHOLD = 14
local PREDICTION_FACTOR = 0.16

local function GetTarget()
    local targetPlayer = Players:FindFirstChild(TargetBox.Text)
    if targetPlayer and targetPlayer.Character then
        return targetPlayer.Character:FindFirstChild("HumanoidRootPart")
    end
    return nil
end

local function EnableNoclip()
    if LP.Character then
        for _, part in pairs(LP.Character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = false
            end
        end
    end
end

local function StabilizedOrbit(targetPos, targetVel, HRP)
    ORBIT_ANGLE += ANGULAR_SPEED * (0.8 + math.min(targetVel.Magnitude/20, 1.2))
    local orbitOffset = Vector3.new(
        math.cos(math.rad(ORBIT_ANGLE)) * ORBIT_RADIUS,
        1.2,
        math.sin(math.rad(ORBIT_ANGLE)) * ORBIT_RADIUS
    )
    local predictedPos = targetPos + (targetVel * PREDICTION_FACTOR) + orbitOffset
    return (predictedPos - HRP.Position).Unit * FORCE * 0.6
end

local function FlingLoop()
    while Flinging and task.wait() do
        EnableNoclip()
        local HRP = LP.Character and LP.Character:FindFirstChild("HumanoidRootPart")
        Target = GetTarget()
        
        if HRP and Target and Target.Parent then
            local targetPos = Target.Position
            local targetVel = Target.Velocity
            
            -- Proximity stabilization
            if (HRP.Position - targetPos).Magnitude > 4 then
                HRP.CFrame = CFrame.new(targetPos + Vector3.new(0, 1.2, 0))
            end

            -- Velocity-controlled behavior
            if targetVel.Magnitude > VELOCITY_THRESHOLD then
                HRP.Velocity = StabilizedOrbit(targetPos, targetVel, HRP)
            else
                HRP.Velocity = Vector3.new(
                    math.random(-FORCE, FORCE),
                    math.random(-FORCE/2.5, FORCE),
                    math.random(-FORCE, FORCE)
                )
            end

            -- Stable rotation
            HRP.RotVelocity = Vector3.new(
                math.random(-15, 15),
                math.random(-15, 15),
                math.random(-15, 15)
            )
        end
    end
end

-- Toggle System
ToggleBtn.MouseButton1Click:Connect(function()
    Flinging = not Flinging
    ToggleBtn.Text = Flinging and "STOP FLINGING" or "START FLINGING"
    ToggleBtn.BackgroundColor3 = Flinging and Color3.fromRGB(200, 0, 0) or Color3.fromRGB(0, 120, 215)
    
    if Flinging then
        Target = GetTarget()
        if Target and LP.Character then
            LP.Character:WaitForChild("HumanoidRootPart").CFrame = Target.CFrame + Vector3.new(0, 1.5, 0)
        end
        coroutine.wrap(FlingLoop)()
    end
end)

-- Respawn Handling
LP.CharacterAdded:Connect(function()
    if Flinging then
        coroutine.wrap(FlingLoop)()
    end
end)

-- Auto-target refresh
RunService.Heartbeat:Connect(function()
    if Flinging and (not Target or not Target.Parent) then
        Target = GetTarget()
    end
end)

print("Orbital fling system loaded successfully!")
