local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local lp = Players.LocalPlayer

-- GUI Setup
local gui = Instance.new("ScreenGui")
gui.Parent = lp:WaitForChild("PlayerGui")
gui.Name = "FlingSystem"

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 250, 0, 150)
mainFrame.Position = UDim2.new(0.5, -125, 0.5, -75)
mainFrame.BackgroundColor3 = Color3.fromRGB(28, 28, 28)
mainFrame.Active = true
mainFrame.Parent = gui

local dragHandle = Instance.new("TextLabel")
dragHandle.Size = UDim2.new(1, 0, 0, 25)
dragHandle.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
dragHandle.Text = "Fling Controller"
dragHandle.TextColor3 = Color3.new(1, 1, 1)
dragHandle.Parent = mainFrame

-- Dragging system
local dragging = false
local dragStartPos
local frameStartPos

dragHandle.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStartPos = Vector2.new(input.Position.X, input.Position.Y)
        frameStartPos = mainFrame.Position
    end
end)

UIS.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local dragDelta = Vector2.new(input.Position.X, input.Position.Y) - dragStartPos
        mainFrame.Position = UDim2.new(
            frameStartPos.X.Scale, 
            frameStartPos.X.Offset + dragDelta.X,
            frameStartPos.Y.Scale, 
            frameStartPos.Y.Offset + dragDelta.Y
        )
    end
end)

UIS.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

local inputBox = Instance.new("TextBox")
inputBox.Size = UDim2.new(0.9, 0, 0, 30)
inputBox.Position = UDim2.new(0.05, 0, 0.25, 0)
inputBox.PlaceholderText = "Enter username"
inputBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
inputBox.TextColor3 = Color3.new(1, 1, 1)
inputBox.Parent = mainFrame

local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(0.9, 0, 0, 35)
toggleBtn.Position = UDim2.new(0.05, 0, 0.6, 0)
toggleBtn.Text = "START FLING"
toggleBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
toggleBtn.TextColor3 = Color3.new(1, 1, 1)
toggleBtn.Parent = mainFrame

-- Fling System
local flingActive = false
local targetPlayer = nil
local TARGET_USERNAME = ""
local FLING_POWER = 50000
local PREDICTION_FACTOR = 0.15
local DIRECTIONAL_OFFSET = 0.5
local connection = nil

-- Simplified noclip (remove massless)
local function enableNoclip()
    if lp.Character then
        for _, v in pairs(lp.Character:GetDescendants()) do
            if v:IsA("BasePart") then
                v.CanCollide = false
            end
        end
    end
end

lp.CharacterAdded:Connect(function()
    enableNoclip()
    if lp.Character:FindFirstChild("Humanoid") then
        lp.Character.Humanoid:ChangeState(Enum.HumanoidStateType.Physics)
    end
end)

-- Prediction math
local function calculatePredictedPosition(targetRoot)
    local targetVelocity = targetRoot.Velocity
    local basePosition = targetRoot.Position
    local prediction = basePosition + (targetVelocity * PREDICTION_FACTOR)
    
    -- Improved directional offset
    if targetVelocity.Magnitude > 5 then
        prediction += (targetVelocity.Unit * (targetVelocity.Magnitude * 0.3)) -- Reduced offset multiplier
    end
    
    return prediction
end

-- Single maintainFling function (critical fix)
local function maintainFling()
    while flingActive and task.wait(0.15) do -- Reduced frequency further
        pcall(function()
            targetPlayer = getPlayer(TARGET_USERNAME)
            if targetPlayer and targetPlayer.Character and lp.Character then
                local targetRoot = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
                local localRoot = lp.Character:FindFirstChild("HumanoidRootPart")
                
                if targetRoot and localRoot then
                    -- Teleport LOCAL player to target
                    local predictedPos = calculatePredictedPosition(targetRoot)
                    localRoot.CFrame = CFrame.new(predictedPos)
                    
                    -- Apply velocity to TARGET (not local player)
                    local direction = (localRoot.Position - targetRoot.Position).Unit
                    targetRoot.Velocity = direction * FLING_POWER + Vector3.new( -- Changed to targetRoot
                        math.random(-500, 500),
                        math.random(250, 750),
                        math.random(-500, 500)
                    )
                end
            end
        end)
    end
end

-- Updated toggle button logic
toggleBtn.MouseButton1Click:Connect(function()
    flingActive = not flingActive
    toggleBtn.Text = flingActive and "STOP FLING" or "START FLING"
    
    if flingActive then
        TARGET_USERNAME = inputBox.Text
        enableNoclip()
        connection = RunService.Heartbeat:Connect(maintainFling)
    else
        TARGET_USERNAME = ""
        targetPlayer = nil
        if connection then
            connection:Disconnect()
        end
    end
end)

-- Player lookup function
local function getPlayer(name)
    name = name:lower()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= lp and (player.Name:lower():find(name) or player.DisplayName:lower():find(name)) then
            return player
        end
    end
    return nil
end

-- Final cleanup
game:GetService("UserInputService").WindowFocused:Connect(function()
    if connection then connection:Disconnect() end
end)
