-- FE Advanced Fling V5 (Stable)
local UIS = game:GetService("UserInputService")
local RS = game:GetService("RunService")
local Players = game:GetService("Players")
local LP = Players.LocalPlayer
local Mouse = LP:GetMouse()

-- Enhanced GUI with Prediction
local FlingGui = Instance.new("ScreenGui")
local Frame = Instance.new("Frame")
local TargetBox = Instance.new("TextBox")
local ToggleBtn = Instance.new("TextButton")
local Suggestions = Instance.new("ScrollingFrame")

-- Improved Draggable GUI
FlingGui.Name = "FlingControl"
FlingGui.Parent = game.CoreGui
FlingGui.ResetOnSpawn = false

Frame.Parent = FlingGui
Frame.Size = UDim2.new(0, 220, 0, 120)
Frame.Position = UDim2.new(0.5, -110, 0.5, -60)
Frame.BackgroundTransparency = 0.5
Frame.Active = true

-- Proper Drag Implementation
local dragging, dragInput, dragStart, startPos
local function UpdateInput(input)
    local delta = input.Position - dragStart
    Frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

Frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = Frame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

Frame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

UIS.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        UpdateInput(input)
    end
end)

-- Username Prediction System
Suggestions.Name = "Suggestions"
Suggestions.Parent = Frame
Suggestions.Size = UDim2.new(0.9, 0, 0, 80)
Suggestions.Position = UDim2.new(0.05, 0, 1.1, 0)
Suggestions.BackgroundTransparency = 0.7
Suggestions.ScrollBarThickness = 3
Suggestions.Visible = false

local function ShowSuggestions(text)
    Suggestions:ClearAllChildren()
    local count = 0
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LP and player.Name:lower():find(text:lower()) == 1 then
            local btn = Instance.new("TextButton")
            btn.Size = UDim2.new(1, 0, 0, 20)
            btn.Position = UDim2.new(0, 0, 0, count * 22)
            btn.Text = player.Name
            btn.TextColor3 = Color3.new(1, 1, 1)
            btn.BackgroundTransparency = 0.8
            
            btn.MouseButton1Click:Connect(function()
                TargetBox.Text = player.Name
                Suggestions.Visible = false
            end)
            
            btn.Parent = Suggestions
            count += 1
        end
    end
    
    Suggestions.Visible = count > 0
    Suggestions.CanvasSize = UDim2.new(0, 0, 0, count * 22)
end

TargetBox.Parent = Frame
TargetBox.Size = UDim2.new(0.9, 0, 0.3, 0)
TargetBox.Position = UDim2.new(0.05, 0, 0.1, 0)
TargetBox.PlaceholderText = "Enter Username"
TargetBox:GetPropertyChangedSignal("Text"):Connect(function()
    ShowSuggestions(TargetBox.Text)
end)

TargetBox.Focused:Connect(function()
    ShowSuggestions(TargetBox.Text)
end)

TargetBox.FocusLost:Connect(function()
    Suggestions.Visible = false
end)

ToggleBtn.Parent = Frame
ToggleBtn.Size = UDim2.new(0.9, 0, 0.3, 0)
ToggleBtn.Position = UDim2.new(0.05, 0, 0.55, 0)
ToggleBtn.Text = "Toggle Fling"
ToggleBtn.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)

-- Optimized Fling Mechanics
local Flinging = false
local Target = nil
local ROTATION_SPEED = 250 -- Degrees per second (adjust intensity)
local TELEPORT_INTERVAL = 0.08 -- Seconds between teleports
local FLING_FORCE = Vector3.new(0, 1250, 0) -- Upward/downward force
local CHAOS_OFFSET = 5 -- Max position randomness
local VERTICAL_DAMPENING = 0.25  -- Add this
local HORIZONTAL_BOOST = 1.3   -- Add this
local SAFE_DISTANCE = 5        -- Add this

local function GetTarget()
    local targetPlayer = Players:FindFirstChild(TargetBox.Text)
    return targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart")
end

local function ApplyCollision(state)
    if LP.Character then
        for _, part in pairs(LP.Character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.CanCollide = state
            end
        end
    end
end

local function PrecisionFling()
    ApplyCollision(false)
    local HRP = LP.Character and LP.Character:WaitForChild("HumanoidRootPart")
    if not HRP or not Target then return end

    local BodyVelocity = Instance.new("BodyVelocity")
    BodyVelocity.Velocity = Vector3.new()
    BodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    BodyVelocity.P = 100000
    BodyVelocity.Parent = HRP

    while Flinging and task.wait() do
        if not Target.Parent or not HRP.Parent then
            Target = GetTarget()
            if not Target then break end
            HRP = LP.Character:WaitForChild("HumanoidRootPart")
        end

        -- Stabilized Movement System
        local targetPos = Target.Position
        local targetVel = Target.Velocity
        local currentDist = (HRP.Position - targetPos).Magnitude
        
        -- Adaptive Prediction
        local prediction = targetVel * PredictionFactor * math.clamp(targetVel.Magnitude/30, 0.5, 1.2)
        
        -- Force Control
        local force = BaseForce * (1 + (currentDist/15))  -- Smooth distance scaling
        force = math.clamp(force, 3000, 8500)  -- Force boundaries
        
        -- Direction Calculation
        local horizontalDirection = (targetPos + prediction - HRP.Position).Unit
        local verticalAdjust = math.clamp((targetPos.Y - HRP.Position.Y) * VERTICAL_DAMPENING, -1.8, 1.8)
        
        -- Final Velocity
        BodyVelocity.Velocity = (horizontalDirection * HORIZONTAL_BOOST + Vector3.new(0, verticalAdjust, 0)) * force
        
        -- Proximity Stabilizer
        if currentDist < SAFE_DISTANCE then
            BodyVelocity.Velocity = BodyVelocity.Velocity * 0.6
        end
    end

    BodyVelocity:Destroy()
    ApplyCollision(true)
end

-- Death Handling System
LP.CharacterAdded:Connect(function()
    if Flinging then
        ViolentFling()
    end
end)

ToggleBtn.MouseButton1Click:Connect(function()
    Flinging = not Flinging
    ToggleBtn.BackgroundColor3 = Flinging and Color3.new(1, 0, 0) or Color3.new(0.3, 0.3, 0.3)
    
    if Flinging then
        Target = GetTarget()
        if Target then
            coroutine.wrap(ViolentFling)()
        end
    else
        Target = nil
    end
end)

-- Auto-Target Refresh
RS.Heartbeat:Connect(function()
    if Flinging and (not Target or not Target.Parent) then
        Target = GetTarget()
        if not Target then
            Flinging = false
            ToggleBtn.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
        end
    end
end)
