local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- GUI Setup (Same Visual Elements)
local gui = Instance.new("ScreenGui")
gui.ResetOnSpawn = false
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 200, 0, 120)
frame.Position = UDim2.new(0.5, -100, 0.5, -60)
local title = Instance.new("TextLabel")
title.Text = "Fling Controller"
local inputBox = Instance.new("TextBox")
inputBox.PlaceholderText = "Target Username"
local toggleBtn = Instance.new("TextButton")
toggleBtn.Text = "ENABLE FLING"
-- [Parent all GUI elements as previous versions]

-- Dragging Code (Same as Previous Implementations)

-- New Core System
local FlingManager = {
    Active = false,
    Lock = false,
    Handles = {},
    Channels = {
        Main = Instance.new("BindableEvent"),
        Safety = Instance.new("BindableEvent")
    }
}

local function AbsoluteClean()
    -- Nuclear cleanup
    FlingManager.Lock = true
    for _, v in pairs(FlingManager.Handles) do
        if type(v) == "RBXScriptConnection" then
            v:Disconnect()
        elseif v:IsA("Instance") then
            v:Destroy()
        end
    end
    FlingManager.Handles = {}
    FlingManager.Lock = false
end

local function EstablishFling(targetHRP)
    AbsoluteClean()
    if not FlingManager.Active then return end

    -- Original Fling Mechanics
    local localHRP = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    localHRP.CFrame = targetHRP.CFrame

    local anchor = Instance.new("Part")
    anchor.Anchored = true
    anchor.Transparency = 1
    anchor.CFrame = localHRP.CFrame
    anchor.Parent = LocalPlayer.Character
    table.insert(FlingManager.Handles, anchor)

    -- Part setup
    local parts = {}
    for _, part in ipairs(LocalPlayer.Character:GetDescendants()) do
        if part:IsA("BasePart") then
            if part.CanCollide then
                table.insert(parts, part)
                -- Attachment setup
                local att0 = Instance.new("Attachment")
                local att1 = att0:Clone()
                Instance.new("AlignPosition", att0).Attachment1 = att1
                att0.Parent = part
                att1.Parent = anchor
                table.insert(FlingManager.Handles, att0)
                table.insert(FlingManager.Handles, att1)
            else
                part.Velocity = Vector3.new(0, -1000, 0)
            end
        end
    end

    -- Tracking System
    local function UpdateTrack()
        while FlingManager.Active and task.wait() do
            if targetHRP.Parent then
                anchor.CFrame = targetHRP.CFrame
            end
        end
    end

    local function VelocityLoop()
        while FlingManager.Active and task.wait() do
            for _, part in ipairs(parts) do
                part.Velocity = Vector3.new(0, -25.05, 0)
                part.RotVelocity = Vector3.new(9999, 9999, 9999)
            end
        end
    end

    -- Start parallel loops
    table.insert(FlingManager.Handles, task.spawn(UpdateTrack))
    table.insert(FlingManager.Handles, task.spawn(VelocityLoop))

    -- Auto-recovery listener
    FlingManager.Handles.DeathWatch = targetHRP.AncestryChanged:Connect(function()
        if not targetHRP.Parent and FlingManager.Active then
            EstablishFling(targetHRP)
        end
    end)
end

-- New Control System
toggleBtn.MouseButton1Click:Connect(function()
    if FlingManager.Lock then return end
    FlingManager.Active = not FlingManager.Active
    toggleBtn.Text = FlingManager.Active and "DISABLE FLING" or "ENABLE FLING"

    if FlingManager.Active then
        -- Initial activation
        local target = Players:FindFirstChild(inputBox.Text)
        if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
            EstablishFling(target.Character.HumanoidRootPart)
        end

        -- Persistent tracker
        FlingManager.Handles.PlayerWatch = Players.PlayerAdded:Connect(function(newPlayer)
            if newPlayer.Name == inputBox.Text then
                FlingManager.Handles.CharWatch = newPlayer.CharacterAdded:Connect(function(char)
                    EstablishFling(char:WaitForChild("HumanoidRootPart"))
                end)
            end
        end)
    else
        -- Full system kill
        AbsoluteClean()
    end
end)

-- Independent Safety Net
task.spawn(function()
    while task.wait(3) do
        if FlingManager.Active and not FlingManager.Lock then
            -- Verify system integrity
            local valid = false
            if LocalPlayer.Character then
                for _, v in ipairs(LocalPlayer.Character:GetChildren()) do
                    if v.Name == "FlingAnchor" then
                        valid = true
                        break
                    end
                end
            end
            
            if not valid then
                local target = Players:FindFirstChild(inputBox.Text)
                if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") then
                    EstablishFling(target.Character.HumanoidRootPart)
                end
            end
        end
    end
end)
