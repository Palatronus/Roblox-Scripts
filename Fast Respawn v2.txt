local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- Single connection management
local respawnConnection = nil

local function setupRespawn()
    -- Cleanup previous connection if exists
    if respawnConnection then
        respawnConnection:Disconnect()
        respawnConnection = nil
    end
    
    -- Core respawn functionality
    respawnConnection = RunService.Heartbeat:Connect(function()
        if player.Character and player.Character:FindFirstChildOfClass("Humanoid") then
            local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
            if humanoid:GetState() == Enum.HumanoidStateType.Dead then
                player:RequestRespawn()
            end
        end
    end)
end

-- Initial setup
if player.Character then
    setupRespawn()
end

-- Reconnect when new character appears
player.CharacterAdded:Connect(function(character)
    setupRespawn()
end)

-- Cleanup when player leaves
Players.PlayerRemoving:Connect(function(leavingPlayer)
    if leavingPlayer == player and respawnConnection then
        respawnConnection:Disconnect()
    end
end)
