-- Universal Chat Spy Script for Roblox
-- Uses Infinite Yield-inspired approach for reliability
-- Displays messages in the regular Roblox chat UI

if not game:IsLoaded() then
    game.Loaded:Wait()
end

local function createChatSpy()
    -- Server-side component
    local serverScript = [[
        local Players = game:GetService("Players")
        local TextChatService = game:GetService("TextChatService")
        local ReplicatedStorage = game:GetService("ReplicatedStorage")
        
        -- Create remote event
        local ChatSpyRemote
        if not ReplicatedStorage:FindFirstChild("ChatSpyRemote") then
            ChatSpyRemote = Instance.new("RemoteEvent")
            ChatSpyRemote.Name = "ChatSpyRemote"
            ChatSpyRemote.Parent = ReplicatedStorage
        else
            ChatSpyRemote = ReplicatedStorage.ChatSpyRemote
        end
        
        -- Message handler using Infinite Yield approach
        local function onIncomingMessage(message)
            if message.MessageType == "Text" and message.TextSource then
                local player = Players:GetPlayerByUserId(message.TextSource.UserId)
                if player then
                    -- Format message with color
                    local spyMessage = string.format(
                        '<font color="rgb(255,85,85)">[SPY] %s:</font> %s',
                        player.Name,
                        message.Text
                    )
                    -- Send to all clients
                    ChatSpyRemote:FireAllClients(spyMessage)
                end
            end
            return nil
        end
        
        -- Connect to chat events
        if TextChatService.OnIncomingMessage then
            -- Preserve existing handler if present
            local existingHandler = TextChatService.OnIncomingMessage
            TextChatService.OnIncomingMessage = function(message)
                existingHandler(message)
                onIncomingMessage(message)
            end
        else
            TextChatService.OnIncomingMessage = onIncomingMessage
        end
        
        warn("Chat Spy Server Module Activated")
        return true
    ]]
    
    -- Client-side component
    local clientScript = [[
        local ReplicatedStorage = game:GetService("ReplicatedStorage")
        local TextChatService = game:GetService("TextChatService")
        local Players = game:GetService("Players")
        local LocalPlayer = Players.LocalPlayer
        
        -- Wait for remote event
        local ChatSpyRemote
        repeat task.wait(1)
            ChatSpyRemote = ReplicatedStorage:FindFirstChild("ChatSpyRemote")
        until ChatSpyRemote
        
        -- Infinite Yield-style message display
        local function displaySpyMessage(message)
            -- Get the main chat GUI
            local chatGUI = LocalPlayer.PlayerGui:FindFirstChild("Chat", true)
            if not chatGUI then return end
            
            -- Find the message display container
            local messageDisplay
            for _, child in ipairs(chatGUI:GetDescendants()) do
                if child:IsA("ScrollingFrame") and child.Name == "ChatChannelParentFrame" then
                    messageDisplay = child:FindFirstChild("Frame_MessageLogDisplay", true)
                    if messageDisplay then break end
                end
            end
            
            if not messageDisplay then return end
            
            -- Create message label
            local messageLabel = Instance.new("TextLabel")
            messageLabel.Text = message
            messageLabel.RichText = true
            messageLabel.TextSize = 18
            messageLabel.BackgroundTransparency = 1
            messageLabel.TextXAlignment = Enum.TextXAlignment.Left
            messageLabel.Size = UDim2.new(1, 0, 0, 24)
            messageLabel.Parent = messageDisplay
            
            -- Auto-scroll to bottom
            local scrollFrame = messageDisplay.Parent
            if scrollFrame:IsA("ScrollingFrame") then
                scrollFrame.CanvasPosition = Vector2.new(0, scrollFrame.CanvasSize.Y.Offset)
            end
        end
        
        -- Message receiver
        ChatSpyRemote.OnClientEvent:Connect(displaySpyMessage)
        
        print("Chat Spy Client Module Activated")
        return true
    ]]
    
    -- Execution logic
    if is_sirhurt_closure or syn or KRNL_LOADED then
        -- Server injection for executors with server access
        local serverSuccess, serverErr = pcall(function()
            local serverModule = require(game:GetService("ServerScriptService"):WaitForChild("ServerModule", 10))
            if serverModule then
                serverModule:Execute(serverScript)
            else
                error("Could not find ServerModule")
            end
        end)
        
        if not serverSuccess then
            warn("Server injection failed: "..serverErr)
        end
    end
    
    -- Client injection
    local clientSuccess, clientErr = pcall(function()
        local script = Instance.new("LocalScript")
        script.Source = clientScript
        script.Parent = game:GetService("Players").LocalPlayer:WaitForChild("PlayerScripts", 10)
    end)
    
    if not clientSuccess then
        warn("Client injection failed: "..clientErr)
        -- Fallback to direct execution
        loadstring(clientScript)()
    end
    
    return "Chat Spy Activated - Private messages will appear in regular chat"
end

-- Execute the chat spy
local success, result = pcall(createChatSpy)
if not success then
    warn("Chat Spy Error: "..tostring(result))
else
    print(result)
end
