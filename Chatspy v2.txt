-- Universal Chat Spy Script for Roblox
-- Client-side only, reliable with Roblox chat integration

if not game:IsLoaded() then
    game.Loaded:Wait()
end

-- Get necessary services
local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local LocalPlayer = Players.LocalPlayer

-- Function to display spy messages in Roblox chat
local function displaySpyMessage(player, message)
    -- Format with original blue color and proper spacing
    local formatted = string.format(
        '\n<font color="#5555FF">[SPY] %s:</font> %s\n',
        player,
        message
    )
    
    -- Use modern DisplaySystemMessage if available
    if TextChatService.DisplaySystemMessage then
        TextChatService:DisplaySystemMessage(formatted)
    else
        -- Fallback for older clients
        game:GetService("StarterGui"):SetCore("ChatMakeSystemMessage", {
            Text = formatted,
            Color = Color3.fromRGB(85, 85, 255),
            Font = Enum.Font.SourceSansBold,
            TextSize = 18
        })
    end
end

-- Main chat capture function
local function captureChatMessages()
    -- Function to handle player messages
    local function handlePlayerChat(player, message)
        if player ~= LocalPlayer then
            displaySpyMessage(player.Name, message)
        end
    end

    -- Capture existing players
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            player.Chatted:Connect(function(message)
                handlePlayerChat(player, message)
            end)
        end
    end
    
    -- Capture new players
    Players.PlayerAdded:Connect(function(player)
        player.Chatted:Connect(function(message)
            handlePlayerChat(player, message)
        end)
    end)
    
    -- Initial message
    displaySpyMessage("System", "Chat spy activated")
end

-- Initialize with error handling
local success, err = pcall(captureChatMessages)
if success then
    print("Chat Spy Activated - Messages appear in chat with blue [SPY] tags")
else
    warn("Chat Spy Error: "..tostring(err))
    
    -- Ultimate fallback: Use chat commands to test
    LocalPlayer.Chatted:Connect(function(message)
        if message == "/testspy" then
            displaySpyMessage("System", "Spy functionality is active")
        end
    end)
    print("Type '/testspy' in chat to verify spy functionality")
end
